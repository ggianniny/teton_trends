---
title: "Teton Data Cleaning"
author: "Gordon Gianniny"
date: "2023-03-08"
output: html_document
---

```{r, echo=FALSE}
#Loading Packages
library(tidyverse) #For data wrangling
library(lubridate) #For working with dates
library(ggplot2) #Plotting
library(RColorBrewer)
library(patchwork)
library(cpop)
select<-dplyr::select
mutate<-dplyr::mutate
rename<-dplyr::rename
```

## Overview

This script contains code to clean up stream temperature data from the Teton range. The primary goal is to clean up raw data files and combine into a use-able "master" dataframe that can be used to test for temperature trends.

**File format notes**

***NOTE*** This script is written to handle files with the following format: 

  * .csv file with name "Site_NameYYYY.csv" (e.g. windcave2015.csv, s_teton2016.csv) - the year should always correspond to *deployment year*. 
  * A header row with the logger # (should be default format with import from HOBOWare)
  * A date/time column in the format "MM/DD/YY HH:MM AM/PM" (You can get this format by opening the .csv file in excel, selecting the date/time column, and pasting "mm/dd/yy hh:mm AM/PM" into the dialogue box under "custom" cell format)
  * All files should be stored in ONE folder (on my computer, I have these files "Temperature/raw_temp_data/all_years" in the project directory, but you will need to adjust the filepath (in the first chunk of code) depending on where you have data stored. 


**Data Cleaning Steps**

Ways of assessing temperature trends would be: 

1. Comparing mean, max, min temps between years
2. Comparing # degree days - would need to establish cutoff, maybe max temp of 1st year on record? Ecol. meaningful temp cutoffs? 
3. Some type of regression to test for trends over time- Mann-Kendall test or similar?

For any of these analyses, the desired format would be: 
  
* A column for date, rounded to either nearest hour or nearest day to account for slightly different logging times. Range would be date of 1st measurement in 2015 thru last measurement in 2022. 
* Columns for temperature and site (long format) OR columns for temperature for each site (wide format). The former would be better for plotting, while the latter might work better for modeling.   

To generate this data frame, data files (raw or cleaned) will need to be processed as follows for each site: 

1. Read in and clean all data files using a for-loop to: 
  - Rename columns
  - re-format columns (e.g. date) to desired R format
  - Remove unncessary columns
  - Store cleaned files in a list
2. Remove pre- and post-deployment measurements by reading in deployment date data and filtering out pre-/post-deployment observations
3. Deal with outliers by: 
  - Setting observations <0C equal to 0 C 
  - Visually removing obvious exposure periods from sites with issues OR
  - Identifying and removing exposure periods by comparing stream temperature and snotel air temperature data;        removing periods with significant overlap.
4. Fill in missing dates for better plotting, produce cleaned data visualizations, and export both long and wide data frames for future analysis. 


## 1. Site-by-site data cleaning using a for-loop - Data import and organization:

1. Make a list of all filepaths

```{r}
file.list <- list.files("Temperature/raw_temp_data/all_years", full.names = TRUE) 
```

2. Set up a blank list for data frame storage; create a function for extracting site names from filepaths:

```{r}
data_list <- list() #blank list
```

3. Loop over all files to read each dataframe into data_list, make some formatting adjustments: 


```{r, warning=F}
for(i in 1:length(file.list)){
  data_list[[i]]<-read.csv(file.list[i], skip = 1, col.names = c("obs", "date_time", "temp", "x1", "x2", "x3", "x4", "x5")) %>% #read in data files and store as obj in list; rename columns
 select(2, 3)%>% #select second and third cols
 rename("date_tm_char" = 1, "temp_c" = 2)%>% #rename first column "date_tm_char", second column "temp_c" 
 mutate(
 time_chr = substr(date_tm_char, 10, nchar(date_tm_char)), #Extract time (to avoid extra "/" in some files)
 date_chr = substr(date_tm_char, 1, 8), #Extract date (to avoid extra "/" in some files)
  date_tm = round_date(mdy_hms(paste(date_chr, time_chr, sep = " ")), unit = "hours"), #re-combine date and time; convert to R time format rounded to nearest hour     
 site = substr(file.list[i], 37, (nchar(file.list[i])-8)),  #make new column w/site ID  with substring function to select the site name portion of the filepath
 temp_c = as.numeric(temp_c), #recode temp_c as a number
 year = as.numeric(substr(file.list[i], (nchar(file.list[i])-7), (nchar(file.list[i])-4))) #add year column with substring fxn to pull year out of each file name
 )%>%
select(-date_tm_char, -time_chr, -date_chr) #remove unnecessary intermediate cols from date creation
}
```


Check first and last 6 rows of the first item in the list - should have columns "temp_c", "date_tm" (rounded to nearest hour), ""site", and "year". 

```{r}
head(data_list[[1]])
tail(data_list[[1]])
```

----
----

## 2. Dealing with pre-deployment and post-clean up measurements: 

**General Approach:**

  1. Rowbind all dataframes in data_list to get one "master" dataframe with columns "temp_c", "date_tm", "site", and "year".  
  2. Read in a .csv files with the deployment and retrevial dates for each site for each year with columns "year", "site", "deployment_plus1", and "retrevial_minus1". 
  3. Merge these two dataframes by "site" and "year" to get a new dataframe with columns "site", "year", "temp_c", "date_tm", "deployment_plus1", and "retreviall_minus1"
  4. Filter each site to remove any observations with date_tm < deployment_plus1 or > retrevial_minus1 (may need to split back into separate dataframes). 

**1. Rowbind all dataframes in data_list: **

```{r}
full_rbind <- data_list %>%
  bind_rows()

head(full_rbind)
tail(full_rbind)
```


**2. Read in a .csv files with the deployment and retrevial dates for each site for each year with columns "year", "site", "deployment_plus1", and "retrevial_minus1".** 
 (Export from the "Deployment dates" google sheet: https://docs.google.com/spreadsheets/d/1yvyq_zOSwhUTm2_yDDuofD2SFVrExWLZfKlJ-aubgs8/edit?usp=sharing)
 
 NOTE - for adding the 2022-23 data, I removed rows without a corresponding data file (skillet and Grizzly) and got rid of the deployment dates for the 2023-24 data for easier data cleaining. 
 
```{r}
dep_dates <- read.csv("Temperature/deployment_dates.csv")%>% #read datafile - this is the "Deployment dates" tab of the Deployment dates google sheet updated for the current year and saved as a .csv file
  mutate(deployment_plus1 = mdy(deployment_plus1), #re-code deployment_plus1 as a date
         retrieval_minus1 = mdy(retrieval_minus1), #re-code retrieval_minus1 as a date
         year = as.numeric(year) #recode year as numeric
           )
```

**3. Merge these two dataframes by "site" and "year" to get a new dataframe with columns "site", "year", "temp_c", "date_tm", "deployment_plus1", and "retrevial_minus1"**

```{r}
full_dep <- merge(full_rbind, dep_dates, all.x = T) #merge, keep all rows in full_rbind

head(full_dep)
tail(full_dep)#checking outputs
```

**4. Filter each site to remove any observations with date_tm < deployment_plus1 or > retrevial_minus1 (may need to split back into separate dataframes).** 

a. Make new column with site and year to split dataframe by: 

```{r}
full_dep <- full_dep %>%
  mutate(site_yr = paste(site, year, sep = "_"))%>% #new column with SiteName_year
  arrange(site_yr, date_tm)

head(full_dep) #Check output
```

b. Split by site_yr column to get a list of dataframes, one for each year for each site: 

```{r}
full_dep_split <- split(full_dep, full_dep$site_yr)

head(full_dep_split[[1]]) 
head(full_dep_split[[10]]) #Checking a few entries to ensure split was carried out correctly
```

c. Write a function to filter out any columns with date_tm <deployment_plus1 or date_tm > retrieval_minus1:

```{r}
deployment.fxn <- function(df){
  df <- df %>% #overwrite with new dataframe
    filter(!(date_tm < deployment_plus1), #remove any rows where date_tm is < deployment_plus1
           !(date_tm > retrieval_minus1)) # or > retrieval_minus1
}
```

d. Apply this function to the split list to remove pre/post deployment measures for each site and year: 

```{r}
cleaned_split <- lapply(full_dep_split, deployment.fxn)

head(full_dep_split[[1]])
head(cleaned_split[[1]])#check beginning


tail(full_dep_split[[1]])
tail(cleaned_split[[1]])# and end of first dataframe to confirm that correct dates were removed
```



e. Re-combine split dataframes to get back to cleaned master dataframe: 

```{r}
clean_rbind <- cleaned_split %>%
  bind_rows()%>% #re-combine into single DF
  select(site, year, date_tm, temp_c) #select desired cols

#Check output: 

head(clean_rbind)
tail(clean_rbind)
```

### Initial data visualization and checking: 

Line graphs and scatterplots for the entire period of record for each site: 

```{r}
site.lines <- ggplot(clean_rbind, aes(x = date_tm, y = temp_c, color = site))+
  geom_line()+
  facet_wrap(~site, scales = "free")+
  theme_classic()+
  theme(legend.position = "none")+
  labs(x = "Date", y = "Stream temperature, C")
site.lines
site.scatter <- ggplot(clean_rbind, aes(x = date_tm, y = temp_c, color = site))+
  geom_point(pch = 20, size = 0.1)+
  facet_wrap(~site, scales = "free")+
  theme_classic()+
  theme(legend.position = "none")+
  labs(x = "Date", y = "Stream temperature, C")
site.scatter
```

Save these plots: 

```{r}
#Line: 
ggsave("Temperature/plots/site_line.pdf", plot = site.lines, device = "pdf", dpi = "retina", width = 10, height = 10, units = "in")
#Point:
ggsave("Temperature/plots/site_scatter.pdf", plot = site.scatter, device = "pdf", dpi = "retina", width = 10, height = 10, units = "in")

```


---
---


## 3. Dealing with outliers, errors, etc. 

### A. Low outliers: Set all values <0 C = 0 C: 

```{r}
clean_zero <- clean_rbind %>%
  mutate(temp_raw = temp_c, 
         temp_c = if_else(temp_c < 0, 0, temp_c)) #adding column with raw/uncorrected temps to include temps <0
```

Check resulting plot to confirm results: 

```{r}
zero.scatter <- ggplot(clean_zero, aes(x = date_tm, y = temp_c, color = site))+
  geom_point(pch = 20, size = 0.1)+
  facet_wrap(~site, scales = "free")+
  theme_classic()+
  theme(legend.position = "none")+
  labs(x = "Date", y = "Stream temperature, C")
zero.scatter
```

###B. Adding missing dates to get rid of connecting lines during periods with no data: 

```{r}
site_split <- split(clean_zero, clean_zero$site) # split into 17 df's, one for each site
```

Write function to fill in missing dates & apply to this list: 

```{r}
fill.date <- function(df){
  df <- df %>%
    mutate(date1 = as.Date(date_tm))%>%
    complete(date1 = seq.Date(from = min(date1), to = max(date1), by = "day"))
}

site_split_filled <- lapply(site_split, fill.date)

ggplot(site_split_filled$windcave, aes(x = date1, y = temp_c))+
  geom_line()
```

Re-combine into single dataframe for further cleaning: 

```{r}
filled_clean <- site_split_filled %>%
  bind_rows()
```


### C. Site-by-site data cleaning: 

Sites of concern are: Cloudveil (spike in 2019), Windcave (spike in 2019), closer look at paintbrush to check for possible exposures. 

#### I. Cloudveil: 

First - plot the section in question: 

```{r}
cloudveil.exposure <- ggplot(filter(filled_clean, site == "cloudveil" & date_tm < "2019-09-28"&date_tm > "2019-09-10") , aes(x = date_tm, y = temp_c)
                                    )+
  geom_point()
cloudveil.exposure
```

After narrowing down the dates - Logger appears to have been exposed from Sep 11th-27th, 2019 - Removing this period plus one day on either side from the dataset: 

```{r}
fully_cleaned1 <- filled_clean %>%
  filter(!(site == "cloudveil" & date_tm < "2019-09-28"&date_tm > "2019-09-10")) #remove rows with site = cloudveil and dates between 9/10-9/28/19
```

Check the resulting plot: 

```{r}
cloudveil.cleaned <- ggplot(filter(fully_cleaned1, site == "cloudveil"), aes(x = date_tm, y = temp_c))+
  geom_point()
cloudveil.cleaned
```

Appears to be one additional outlier in summer of 2021 - remove this observation and check result: 

```{r}
fully_cleaned2 <- fully_cleaned1%>%
  filter(!(site == "cloudveil"& temp_c >6))

cloudveil.cleaned2 <- ggplot(filter(fully_cleaned2, site == "cloudveil"), aes(x = date_tm, y = temp_c))+
  geom_point()
cloudveil.cleaned2

```

Success! On to the next site: 

#### II. Wind Cave: 

Plot the section in question: 

```{r}
wc.exposure <- ggplot(filter(clean_zero, site == "windcave" & date_tm < "2018-08-01"&date_tm > "2018-06-17") , aes(x = date_tm, y = temp_c)
                                    )+
  geom_point()
wc.exposure
```

Exposure appears to have started around June 18th, 2018 - removing everything from 6/17-8/1/18: 

```{r}
fully_cleaned3 <- fully_cleaned2 %>%
  filter(!(site == "windcave" & date_tm < "2018-08-01"&date_tm > "2018-06-17"))
```

Check full wind cave plot to see if successful: 

```{r}
wc.cleaned <- ggplot(filter(fully_cleaned3, site == "windcave"), aes(x = date_tm, y = temp_c))+
  geom_point()
wc.cleaned
```

Additional exposure or error in beginning of 2022-23 data - check this period: 

```{r}
wc.exposure2 <- ggplot(filter(clean_zero, site == "windcave" & date_tm < "2022-08-25"&date_tm > "2022-08-01") , aes(x = date_tm, y = temp_c)
                                    )+
  geom_point()
wc.exposure2
```

Error appears to go from the beginning of Aug through Aug 25th - removing everything from 8/1-8/25/23: 

```{r}
fully_cleaned4 <- fully_cleaned3 %>%
  filter(!(site == "windcave" & date_tm < "2022-08-25"&date_tm > "2022-08-01"))
```


Check full wind cave plot to see if successful: 

```{r}
wc.cleaned2 <- ggplot(filter(fully_cleaned4, site == "windcave"), aes(x = date_tm, y = temp_c))+
  geom_point()
wc.cleaned2
```

Success.

Appears to be additional error in late 2024:

```{r}
wc.exposure2 <- ggplot(filter(clean_zero, site == "windcave" & date_tm < "2024-08-30"&date_tm > "2024-07-19") , aes(x = date_tm, y = temp_c)
                                    )+
  geom_point()
wc.exposure2
```

Error appears to go from the end of July through Aug 25th - removing everything from 7/19-8/30/24: 

```{r}
fully_cleaned5 <- fully_cleaned4 %>%
  filter(!(site == "windcave" & date_tm < "2024-08-25"&date_tm > "2024-07-19"))
```

Check full wind cave plot to see if successful: 

```{r}
wc.cleaned3 <- ggplot(filter(fully_cleaned5, site == "windcave"), aes(x = date_tm, y = temp_c))+
  geom_point()
wc.cleaned3
```

#### III. Paintbrush: 


##### IIIa. Comparison with air temps: 

```{r}
airtemp <- read.csv("snotel_airtemps2024.csv")%>% #read in CSV with air temps for Phillips Bench & Grand Targhee
  mutate(Date = mdy(Date))%>% #re-code date column as date
  rename(targhee_f = 2, phillips_f = 3)%>% #rename temperature cols
  mutate(targhee_c = (targhee_f-32)*(5/9), 
         phillips_c = (as.numeric(phillips_f)-32)*(5/9))%>% #calculate temp in C for each site. 
  select(Date, targhee_c, phillips_c)
```

Combine air temp and stream temp data: 

```{r}
pb <- filter(fully_cleaned5, site == "paintbrush")%>% #select data for paintbrush
  mutate(Date = ymd(date1))%>% #extract just date w/out time from date_tm col
  group_by(Date, year)%>% #group by day
  summarise(stream_temp = mean(temp_c, na.rm = T), 
            temp_range = (max(temp_c, na.rm = T)-min(temp_c, na.rm = T))) #calculate mean daily temp

pb.air <- merge(pb, airtemp, all = T)%>% #merge with air temps
  pivot_longer(!c(Date, year, temp_range), names_to = "measure", values_to = "temp_c")%>% #pivot longer for plotting
  mutate(measure = if_else(measure == "stream_temp", "z_pb_t", measure), 
         year = year(Date))%>%
  filter(!year == 2015, !year == 2016)
```

Compare stream and air temps over entire period of record: 

```{r}
ggplot(pb.air, aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()

```


Examine each year: 

2017:

```{r}
pb.17 <- ggplot(filter(pb.air, year == 2017 ), aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  theme(legend.position = "none")
pb.17 
```

2018: 

```{r}
pb.18<-ggplot(filter(pb.air, year == 2018 ),  aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  theme(legend.position = "none")
pb.18
```

2019: 

```{r}
pb.19 <- ggplot(filter(pb.air, year == 2019 ),  aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  theme(legend.position = "none")
pb.19
```

2020: 

```{r}
pb.20<- ggplot(filter(pb.air, year == 2020 ),  aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  theme(legend.position = "none")
pb.20
```

2021: 

```{r}
pb.21 <- ggplot(filter(pb.air, year == 2021 ),  aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  theme(legend.position = "none")
pb.21
```

2022: 

```{r}
pb.22 <- ggplot(filter(pb.air, year == 2022 ),  aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  theme(legend.position = "bottom")
pb.22
```
2023: 

```{r}
pb.23 <- ggplot(filter(pb.air, year == 2023 ),  aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  theme(legend.position = "bottom")
pb.23
```

2024: 

```{r}
pb.24 <- ggplot(filter(pb.air, year == 2024 ),  aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  theme(legend.position = "bottom")
pb.24
```

Stack all years and save: 

```{r}
pb.stack <- pb.17/pb.18/pb.19/pb.20/pb.21/pb.22/pb.23/pb.24
pb.stack
```

Save this plot: 

```{r}
ggsave("Temperature/plots/paintbrush.jpg", plot = pb.stack, device = "jpeg", width = 9, height = 12, dpi = "retina")

```

Substantial periods of overlap between and air temperatures each summer - could be due to exposure or due to losing flow and having logger in stagnant pool... hard to tell. 

##### IIIb. Testing a diel temp change filter

First, need to calculate daily temperature range for each day within each site:

```{r}
diel_tc <- fully_cleaned4 %>%
  group_by(site, date1)%>%
  summarise(t_xbar = mean(temp_c, na.rm = T), 
            t_min = min(temp_c, na.rm = T), 
            t_max = max(temp_c, na.rm = T))%>%
  mutate(t_range= t_max-t_min)%>%
  complete(date1 = seq.Date(from = min(date1), to = max(date1), by ="day" ))%>%
  mutate(flag = if_else(t_range >= 10, "X", "OK"), 
         flag = if_else(is.na(flag), "X", flag))
```

Plot Paintbrush with color depending on flag

```{r}
ggplot(filter(diel_tc, site == "paintbrush"), aes(x = date1, y = t_xbar, color = flag))+
  geom_line()+
  theme_classic()

```

Does appear to be identifying periods with overlap - how well? Merge with air temps, check visualizations for each year: 

```{r}
pb_diel <- diel_tc %>%
  filter(site == "paintbrush")%>%
  rename(Date = date1)%>%
  filter(!flag == "X")

pb_diel_air <- merge(pb_diel, airtemp, all = T)%>%
  pivot_longer(!c(Date, site, t_min, t_max, t_range, flag), names_to = "type", values_to = "temp_c")%>%
  mutate(year = year(Date))%>%
  mutate(type = if_else(type == "t_xbar", "z_pb_t", type))%>%
  filter(!year == 2015,! year == 2016)
```

Check plot w/out flagged data:

```{r}
pb.cleaned <- ggplot(pb_diel_air, aes(x = Date, y = temp_c, color = type))+
  geom_line()+
  theme_classic()+
  facet_wrap(~year, nrow = length(unique(pb.air$year)), ncol =1, scales = "free")+
  theme(strip.text = element_blank())+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#984EA3","#FF7F00","#377EB8"), labels = c("Phillips (Air)", "Targhee (Air)", "Paintbrush (Stream)"))
pb.cleaned
```

Save this plot: 

```{r}
ggsave("Temperature/plots/paintbrush_cleaned.jpg", plot = pb.cleaned, device = "jpeg", width = 9, height = 12, dpi = "retina")
```

Comparison to uncleaned: 

```{r}
pb.uncleaned <- ggplot(pb.air, aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  facet_wrap(~year, nrow = length(unique(pb.air$year)), ncol =1, scales = "free")+
  theme(strip.text = element_blank())+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#984EA3","#FF7F00","#377EB8"), labels = c("Phillips (Air)", "Targhee (Air)", "Paintbrush (Stream)"))
pb.uncleaned
```

Save:

```{r}
ggsave("Temperature/plots/paintbrush_uncleaned.jpg", plot = pb.uncleaned, device = "jpeg", width = 9, height = 12, dpi = "retina")
```


Comparing 10, 13, 15, and no filter (above):

Remove if TD >=10: 

```{r}
pb_10 <- pb.air%>%
  mutate(temp_c = ifelse(temp_range >= 10&measure == "z_pb_t", NA, temp_c))


pb.10 <- ggplot(pb_10, aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  facet_wrap(~year, nrow = length(unique(pb.air$year)), ncol =1, scales = "free")+
  theme(strip.text = element_blank())+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#984EA3","#FF7F00","#377EB8"), labels = c("Phillips (Air)", "Targhee (Air)", "Paintbrush (Stream)"))
pb.10
```


Remove if TD >=13: 

```{r}
pb_13 <- pb.air%>%
  mutate(temp_c = ifelse(temp_range >= 13&measure == "z_pb_t", NA, temp_c))


pb.13 <- ggplot(pb_13, aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  facet_wrap(~year, nrow = length(unique(pb.air$year)), ncol =1, scales = "free")+
  theme(strip.text = element_blank())+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#984EA3","#FF7F00","#377EB8"), labels = c("Phillips (Air)", "Targhee (Air)", "Paintbrush (Stream)"))
pb.13
```

Remove if TD >=15: 

```{r}
pb_15 <- pb.air%>%
  mutate(temp_c = ifelse(temp_range >= 15&measure == "z_pb_t", NA, temp_c))


pb.15 <- ggplot(pb_15, aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  facet_wrap(~year, nrow = length(unique(pb.air$year)), ncol =1, scales = "free")+
  theme(strip.text = element_blank())+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#984EA3","#FF7F00","#377EB8"), labels = c("Phillips (Air)", "Targhee (Air)", "Paintbrush (Stream)"))
pb.15
```

Save these plots: 

```{r}
ggsave("Temperature/plots/paintbrush_10.jpg", plot = pb.10, device = "jpeg", width = 9, height = 12, dpi = "retina")
ggsave("Temperature/plots/paintbrush_13.jpg", plot = pb.13, device = "jpeg", width = 9, height = 12, dpi = "retina")
ggsave("Temperature/plots/paintbrush_15.jpg", plot = pb.15, device = "jpeg", width = 9, height = 12, dpi = "retina")
```


##### IIIc. Manual cleaning for periods with overlap: 
##### (Method used for final dataset)

First step: Identify years and times that appear to have significant overlap: 

```{r}
pb.uncleaned
```

Based on this plot, problem areas appear to be:

  - Aug-Oct 2018
  - Sep-Oct 2019
  - Aug-Oct 2020
  - Aug-Oct 2021
  - Aug-Oct 2022
  
(2017 & 2022 look ok)

Cleaning year-by year - General approach: 

  1. Create plot of the problem area - Looking for:
    a. Overlap - stream temp about the same as air temp AND
    b. Trend - stream temp following the same trends at the same magnitudes as air temps. 
  2. Adjust the date range on the plot to identify the last day without overlap and first day after overlap ends
  3. Create a new object with the range of problem dates for cleaning

**2018**

Plot:

```{r}
pb.18<-ggplot(filter(pb.air, Date >= "2018-08-20" & Date <= "2018-10-14"), aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#984EA3","#FF7F00","#377EB8"), labels = c("Phillips (Air)", "Targhee (Air)", "Paintbrush (Stream)"))
pb.18
```

Problem period is **8/21-10/13/18**. Save these dates for later: 

```{r}
exposure.18 <- seq.Date(from = as.Date("2018-08-21"), to = as.Date("2018-10-13"), by = "day")
```

**2019**

Plot:

```{r}
pb.19<-ggplot(filter(pb.air, Date >= "2019-08-23" & Date <= "2019-10-02"), aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#984EA3","#FF7F00","#377EB8"), labels = c("Phillips (Air)", "Targhee (Air)", "Paintbrush (Stream)"))
pb.18
```

Problem period is **08-23 to 10-02**. Save these dates for later: 

```{r}
exposure.19 <- seq.Date(from = as.Date("2019-08-23"), to = as.Date("2019-10-02"), by = "day")
```

**2020**

Plot:

```{r}
ggplot(filter(pb.air, Date >= "2020-08-28" & Date <= "2020-10-11"), aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#984EA3","#FF7F00","#377EB8"), labels = c("Phillips (Air)", "Targhee (Air)", "Paintbrush (Stream)"))
```

Problem period is **08-28 to 10-11**. Save these dates for later: 

```{r}
exposure.20 <- seq.Date(from = as.Date("2020-08-28"), to = as.Date("2020-10-11"), by = "day")
```

**2021**

Plot:

```{r}
ggplot(filter(pb.air, Date >= "2021-08-05" & Date <= "2021-10-09"), aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#984EA3","#FF7F00","#377EB8"), labels = c("Phillips (Air)", "Targhee (Air)", "Paintbrush (Stream)"))
```

Problem period is **08-05 to 10-09**. Save these dates for later: 

```{r}
exposure.21 <- seq.Date(from = as.Date("2021-08-05"), to = as.Date("2021-10-09"), by = "day")
```

**2022**

Plot:

```{r}
ggplot(filter(pb.air, Date >= "2022-08-19" & Date <= "2022-10-15"), aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#984EA3","#FF7F00","#377EB8"), labels = c("Phillips (Air)", "Targhee (Air)", "Paintbrush (Stream)"))
```

Problem period is **08-19 to 10-15**. Save these dates for later: 

```{r}
exposure.22 <- seq.Date(from = as.Date("2022-08-19"), to = as.Date("2022-10-15"), by = "day")
```

**2023**

```{r}
ggplot(filter(pb.air, Date >= "2023-08-04" & Date <= "2023-10-27"), aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#984EA3","#FF7F00","#377EB8"), labels = c("Phillips (Air)", "Targhee (Air)", "Paintbrush (Stream)"))
```

Problem period is **08-04 to 10-27**. Save these dates for later: 

```{r}
exposure.23 <- seq.Date(from = as.Date("2023-08-04"), to = as.Date("2023-10-28"), by = "day")
```

**2024**

```{r}
ggplot(filter(pb.air, Date >= "2024-08-04" & Date <= "2024-10-27"), aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#984EA3","#FF7F00","#377EB8"), labels = c("Phillips (Air)", "Targhee (Air)", "Paintbrush (Stream)"))
```

All 2024 Data looks good. 




**Removing these date ranges from the paintbrush data in the complete dataset:**

```{r}
fully_cleaned6 <- fully_cleaned5 %>%
  filter(!(site == "paintbrush"&date1>=min(exposure.18)&date1<=max(exposure.18)), 
         !(site == "paintbrush"&date1>=min(exposure.19)&date1<=max(exposure.19)),
         !(site == "paintbrush"&date1>=min(exposure.20)&date1<=max(exposure.20)),
         !(site == "paintbrush"&date1>=min(exposure.21)&date1<=max(exposure.21)), 
         !(site == "paintbrush"&date1>=min(exposure.22)&date1<=max(exposure.22)), 
         !(site == "paintbrush"&date1>=min(exposure.23)&date1<=max(exposure.23))
         )
```


Make dataframe with exposure dates for future reference:

```{r}
exposure_dates <- as.data.frame(c(exposure.18, exposure.19, exposure.20, exposure.21, exposure.22, exposure.23))%>%
  rename(exposed_dates = 1)%>%
  mutate(yr = year(exposed_dates)) 

write.csv(exposure_dates, "Temperature/pb_exposure.csv")

```

Check resulting plot: 

```{r}
ggplot(filter(fully_cleaned6, site == "paintbrush"), aes(x = date1, y = temp_c))+
  geom_point()+
  theme_classic()

```

Appears to have successfully removed the desired sections from each year - use this file (fully_cleaned5) for future calculations and analysis.

######a.  Create quick plot with dry days: 

Prep data:

```{r}
pb_dry <- data.frame(c(2018, 2019, 2020, 2021, 2022, 2023), c(length(exposure.18), length(exposure.19), length(exposure.20), length(exposure.21), length(exposure.22), length(exposure.23)))%>% #create data frame with years, length of sections trimmed out of data for each year
  rename("year" = 1, "dry_days" = 2) #renaming columns
```

Plotting:

```{r}
pb.drydays <- ggplot(pb_dry, aes(x = year, y = dry_days, fill = dry_days))+
  geom_bar(stat = "identity", position = "dodge")+
  theme_classic()+
  scale_fill_gradient(low = "#fdae6b", high ="#412201")+
  labs(x= "Year", y = "Number of dry days")+
  scale_x_continuous(breaks = c(2018, 2019, 2020, 2021, 2022, 2023))+
  theme(
    axis.text = element_text(size = 10), 
    axis.title = element_text(size = 11, face = "bold"), 
    legend.position = "none"
  )
pb.drydays
```

Save:

```{r}
ggsave("Temperature/plots/pb_dry_days.jpg", pb.drydays, width = 8.5, height = 6.5, units = "in", device = "jpeg", dpi = "retina")
```

#### IV. S AK Basin

##### A. Removing extra measurements from 2016 & 2017

First, plot n obs to identify error:

```{r}
fully_cleaned6%>%
  filter(site=="s_ak_basin")%>%
  mutate(year=year(date1))%>%
  group_by(year)%>%
  summarise(n_obs = length(temp_c))%>%
  ggplot(aes(x = year, y = n_obs))+
  geom_bar(stat="identity", position = "dodge")+
  scale_x_continuous(breaks=c(2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024))
```

Years with 15min logging interval are 2016 and 2017. 

Goal = average each set of 4 logging intervals with same date_tm

```{r}
fully_cleaned7 <- fully_cleaned6%>%
  group_by(date_tm, date1, site, year)%>% #group by date_tm to combine non-unique values, retain other cols
  summarise(temp_c = mean(temp_c), 
         temp_raw = mean(temp_raw)) #calculate mean of 15min readings to get hourly reading

head(filter(fully_cleaned7, site=="s_ak_basin"))
```

Check if successful:

```{r}
fully_cleaned7%>%
  filter(site=="s_ak_basin")%>%
  mutate(year=year(date1))%>%
  group_by(year)%>%
  summarise(n_obs = length(temp_c))%>%
  ggplot(aes(x = year, y = n_obs))+
  geom_bar(stat="identity", position = "dodge")+
  scale_x_continuous(breaks=c(2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024))
```

Seems to have worked - reality check length of time for 2016 and 17:

```{r}
ggplot(filter(fully_cleaned7, site == "s_ak_basin"), aes(x = date1, y = temp_c))+
  geom_point()+
  theme_classic()
```

##### B. 2019 & 2020 problem areas

###### i. Manual removal of overlap between stream temp + Grand Targhee air temp. 

Combine Airtemp + S AK Basin Data:

```{r}
s_ak <- filter(fully_cleaned7, site == "s_ak_basin")%>% #select data for paintbrush
  mutate(Date = ymd(date1))%>% #extract just date w/out time from date_tm col
  group_by(Date, year)%>% #group by day
  summarise(stream_temp = mean(temp_c, na.rm = T), 
            temp_range = (max(temp_c, na.rm = T)-min(temp_c, na.rm = T))) #calculate mean daily temp

s_ak.air <- merge(s_ak, airtemp, all = T)%>% #merge with air temps
  pivot_longer(!c(Date, year, temp_range), names_to = "measure", values_to = "temp_c")%>% #pivot longer for plotting
  mutate(measure = if_else(measure == "stream_temp", "z_sak_t", measure), 
         year = year(Date))

```

**2019**

```{r}
sak.19<- ggplot(filter(s_ak.air, Date >= "2019-08-10" & Date <= "2019-10-19", measure == "z_sak_t"|measure=="targhee_c"), aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#FF7F00","#377EB8"), labels = c("Targhee (Air)", "S AK Basin (Stream)"))
sak.19
```

**2020**

```{r}
sak.20<-ggplot(filter(s_ak.air, Date >= "2020-08-10" & Date <= "2020-11-01", measure == "z_sak_t"|measure=="targhee_c"), aes(x = Date, y = temp_c, color = measure))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Mean Daily Temperature, C", color = "Temp. Type")+
  scale_color_manual(values = c("#FF7F00","#377EB8"), labels = c("Targhee (Air)", "S AK Basin (Stream)"))
sak.20
```


Not an exact match in either year - comparison with paintbrush: 

```{r}
(sak.19|sak.20)/(pb.18|pb.19)
```

###### ii. Diel temp change Removal



###### iii. Manual removal from visual assessment 

```{r}
ggplot(filter(fully_cleaned7, site == "s_ak_basin", year ==2019|year==2020), aes(x = date1, y = temp_c))+
  geom_line()+
  theme_classic()
```

Appears to be some very high/variable readings in both years. Pattern is a gradual uncrease in T, then dramatic fluctuations up/down, then dropping to zero (or below) and continuing rapid fluctuation. Seems consistent with exposure.

Manually Isolating error periods: 

2019:

```{r}
ggplot(filter(fully_cleaned7, site == "s_ak_basin", date1 >= "2019-08-15" & date1 <= "2019-10-20"), aes(x = date_tm, y = temp_raw))+
  geom_line()+
  theme_classic()
```

2019 problem dates are ~8/15-10/20 - save for later:

```{r}
s.ak.19 <- seq.Date(from = as.Date("2019-08-15"), to = as.Date("2019-10-20"), by = "day")
```

2020:

```{r}
ggplot(filter(fully_cleaned7, site == "s_ak_basin", date1 >= "2020-06-15" & date1 <= "2020-11-11"), aes(x = date_tm, y = temp_c))+
  geom_line()+
  theme_classic()
```

2020 problem range = 8/15, end = 11/11. Save for later:

```{r}
s.ak.20 <- seq.Date(from = as.Date("2020-08-15"), to = as.Date("2020-11-11"), by = "day")
```

Remove problem periods from data:

```{r}
fully_cleaned8 <- fully_cleaned7 %>%
  filter(!(site == "s_ak_basin"&date1>=min(s.ak.19)&date1<=max(s.ak.19)), 
         !(site == "s_ak_basin"&date1>=min(s.ak.20)&date1<=max(s.ak.20))
         )
```

Check if successful:

```{r}
ggplot(filter(fully_cleaned8, site == "s_ak_basin", year ==2019|year==2020), aes(x = date1, y = temp_c))+
  geom_point()+
  scale_y_continuous(limits = c(0, 12))+
  theme_classic()
```

**Other cleaning idea: calculate daily temp range, plot over time, run thru cpop to pull slope breaks around areas in question and trim based on those**


### D. Some Final Cleaning/organizing for optimal plotting: 

Re-filling missing date ranges after cleaning:

```{r}
full_clean_split <- split(fully_cleaned8, fully_cleaned8$site) # split into 17 df's, one for each site
```

Apply previously constructed function to this list to re-fill dates: 

```{r}
#full_clean_filled_split <- lapply(full_clean_split, fill.date) #apply function

ggplot(full_clean_filled_split$windcave, aes(x = date1, y = temp_c))+ #check windcave to see if successful
  geom_line()
```

Re-combine into single dataframe for further cleaning: 

```{r}
temps_final <- full_clean_filled_split %>%
  bind_rows(.id = "site")
```

Check if successful after rowbind:

```{r}
ggplot(filter(temps_final, site == "windcave"), aes(x = date1, y = temp_c))+
  geom_line()
```


---
---

## 4. Final data visualization using cleaned temperature data; data export for future analysis: 

```{r}
cleaned.lines <- ggplot(filter(temps_final, !site == "death_canyon"), aes(x = date1, y = temp_c, color = site))+
  geom_line()+
  facet_wrap(~site, scales = "free")+
  theme_classic()+
  theme(legend.position = "none")+
  labs(x = "Date", y = "Stream temperature, C")
cleaned.lines
```

```{r}
#Line: 
ggsave("Temperature/plots/cleaned_line.pdf", plot = cleaned.lines, device = "pdf", dpi = "retina", width = 10, height = 10, units = "in")
```

**Adding site coordinates for all sites with 3+ years of data:**

Read in coordinates (source = field sheet PDFs):

```{r}
coords <- read.csv("site_coordinates.csv")
```

Merge with temperature dataset:

```{r}
temps_final1 <- merge(temps_final, coords, all.x = T)%>%
  arrange(site, date1)%>%
  mutate(year = year(date1))
```


**Data Export - both full hourly data and daily mean/min/max data**:

Hourly data:

```{r}
write.csv(temps_final1, "Temperature/cleaned_full_datasets/temps_hourly.csv")
```

Daily mean, min, and max temps: 

```{r}
temp_avgs <- temps_final1%>%
  group_by(site, date1)%>%
  summarise(temp_xbar = mean(temp_c), 
         temp_max = max(temp_c), 
         temp_min = min(temp_c), 
         lat = unique(lat), 
         long = unique(long), 
         temp_change =temp_max-temp_min) #adding diel temperature fluctuation

write.csv(temp_avgs, "Temperature/cleaned_full_datasets/temps_daily.csv")
```
  
---
---

## 5. Updated plots for TASR Presentation:

**TASR temperature plot, faceted by site, color coded by source:** 

Data Prep:

```{r}
source <- read.csv("source_info.csv")%>%
  rename(site = stream) #read in source info, rename cols for merge

tasr.sites <- c("cloudveil", "delta", "grizzly", "gusher", "mid_teton", "n_teton", "paintbrush", "s_ak_basin", "s_cascade", "s_teton", "skillet", "windcave") #make list of TASR sites

tasr_dat <- merge(temps_final1, source)%>% #add source info to final temp dataset
  filter(site%in%tasr.sites) #remove non-TASR sites

pres.pal <- c("#C26ED6", "#F89225", "#76D96F")
```

Plotting: 

```{r}
tasr.lines <- ggplot(tasr_dat, aes(x = date1, y = temp_c, color = source))+
  geom_line()+
  facet_wrap(~full_name, scales = "free_x", nrow = 2, ncol = 6)+
  theme_classic()+
  labs(x = "Date", y = "Stream Temperature, C", color = "Stream Source")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Rock Glacier"))+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
tasr.lines
```

Save:

```{r}
ggsave("pres_figures/tasr_full_lines.pdf", tasr.lines, width = 12, height = 5, units = "in", device = "pdf", dpi = "retina")
```

**Facets per site, colored by year**

Add day of year and month column; extract data for July Thru Sep:

```{r}
tasr_summer_doy <- tasr_dat%>%
  mutate(doy = yday(date1), 
         month = month(date1))%>%
  filter(month >=6&month<=8)%>%
  filter(!is.na(year))%>%
  mutate(across(contains("doy"), ~as.Date("2021-12-31") + .x))%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"))%>%
  mutate(source_name = paste(source_print, full_name, sep = " - "), 
         year=year(date1))%>%
  group_by(date1, source_name, site, full_name, source, doy, year, month)%>%
  summarise(temp_xbar = mean(temp_c))
```


Draw plot of July-Sep data - line graph faceted by site x = day of year, y = temp, color = year


```{r}
tasr.doy <- ggplot(tasr_summer_doy, aes(x = doy, y = temp_xbar, color = factor(year)))+
  geom_line()+
  facet_wrap(~source_name)+
  theme_classic()+
  scale_color_manual(values = rev(brewer.pal(10, "RdYlGn")))+
  labs(x = "Date", y = "Stream Temperature, C", color = "Year")+
  theme(legend.position = "right", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))+
  scale_x_date(date_labels = "%b-%d")
tasr.doy
```

Save:

```{r}
ggsave("pres_figures/tasr_stacked_years.pdf", tasr.doy, width = 12, height = 5, units = "in", device = "pdf", dpi = "retina")
```

#### 5a. Boxplot of all summer data over time grouped by source**

All summer data, free Y axis:

```{r}
boxplot.pal <- c(brewer.pal(3, "Purples"), brewer.pal(5, "Greens"), brewer.pal(4, "Oranges"))

summer.boxplot <- tasr_summer_doy%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"))%>%
  #filter(!site == "windcave")%>%
  ggplot(aes(x = factor(year), y = temp_xbar))+
  geom_jitter(aes(x = factor(year), y = temp_xbar, color = source_name))+
   geom_boxplot(fill = NA)+
  theme_classic()+
  labs(x = "Year", y = "Mean daily temperature, June 1 - Aug. 31", color = "Site Name")+
  theme(
    axis.title = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold"), 
    legend.position = "bottom", 
    strip.text = element_text(size = 11, face = "bold")
  )+
  scale_color_manual(values = boxplot.pal)+
  facet_wrap(~source_print, scales = "free_y", nrow = 3, ncol =1)
summer.boxplot
```

Save:

```{r}
ggsave("pres_figures/tasr_summer_boxplot.pdf", summer.boxplot, width = 8.5, height = 11, units = "in", device = "pdf", dpi = "retina")
```

All summer data, fixed Y axis:

```{r}

summer.boxplot.y <- tasr_summer_doy%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"))%>%
  #filter(!site == "windcave")%>%
  ggplot(aes(x = factor(year), y = temp_xbar))+
  geom_jitter(aes(x = factor(year), y = temp_xbar, color = source_name))+
   geom_boxplot(fill = NA)+
  theme_classic()+
  labs(x = "Year", y = "Mean daily temperature, June 1 - Aug. 31", color = "Site Name")+
  theme(
    axis.title = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold"), 
    legend.position = "bottom", 
    strip.text = element_text(size = 11, face = "bold")
  )+
  scale_color_manual(values = boxplot.pal)+
  facet_wrap(~source_print, nrow = 3, ncol =1)
summer.boxplot.y
```

Save:

```{r}
ggsave("pres_figures/tasr_summer_boxplot_fixed.pdf", summer.boxplot.y, width = 8.5, height = 11, units = "in", device = "pdf", dpi = "retina")
```

---

August Only, free Y axis: 


```{r}
aug.boxplot <- tasr_summer_doy%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"))%>%
  filter(
    #!site == "windcave", 
         month == 8)%>%
  ggplot(aes(x = factor(year), y = temp_xbar))+
  geom_jitter(aes(x = factor(year), y = temp_xbar, color = source_name))+
  geom_boxplot(fill = NA)+
  theme_classic()+
  labs(x = "Year", y = "Mean daily temperature, Aug 1 - Aug. 31", color = "Site Name")+
  theme(
    axis.title = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold"), 
    legend.position = "bottom", 
    strip.text = element_text(size = 11, face = "bold")
  )+
    scale_color_manual(values = boxplot.pal)+
  facet_wrap(~source_print, scales = "free_y", nrow = 3, ncol =1)
aug.boxplot
```

```{r}
ggsave("pres_figures/tasr_aug_boxplot.pdf", aug.boxplot, width = 8.5, height = 11, units = "in", device = "pdf", dpi = "retina")
```

August Only, fixed Y axis

```{r}
aug.boxplot.y <- tasr_summer_doy%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"))%>%
  filter(
    #!site == "windcave", 
    month == 8)%>%
  ggplot(aes(x = factor(year), y = temp_xbar))+
  geom_jitter(aes(x = factor(year), y = temp_xbar, color = source_name))+
  geom_boxplot(fill = NA)+
  theme_classic()+
  labs(x = "Year", y = "Mean daily temperature, Aug 1 - Aug. 31", color = "Site Name")+
  theme(
    axis.title = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold"), 
    legend.position = "bottom", 
    strip.text = element_text(size = 11, face = "bold")
  )+
    scale_color_manual(values = boxplot.pal)+
  facet_wrap(~source_print, nrow = 3, ncol =1)
aug.boxplot.y
```

```{r}
ggsave("pres_figures/tasr_aug_boxplot_fixed.pdf", aug.boxplot.y, width = 8.5, height = 11, units = "in", device = "pdf", dpi = "retina")
```


Windcave Only: 

*August*

```{r}
wc.aug.boxplot <- tasr_summer_doy%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"))%>%
  filter(site == "windcave", month == 8)%>%
  ggplot(aes(x = factor(year), y = temp_xbar))+
  geom_jitter(aes(x = factor(year), y = temp_xbar, color = site))+
  geom_boxplot(fill = NA)+
  theme_classic()+
  labs(x = "Year", y = "Mean daily temperature, Aug 1 - Aug. 31", color = "Site Name")+
  theme(
    axis.title = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold"), 
    legend.position = "none", 
    strip.text = element_text(size = 11, face = "bold")
  )+
  scale_color_manual(values="purple")+
  facet_wrap(~source_name, scales = "free_y", nrow = 3, ncol =1)
wc.aug.boxplot
```

*June-Aug*

```{r}
wc.sum.boxplot <- tasr_summer_doy%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"))%>%
  filter(site == "windcave")%>%
  ggplot(aes(x = factor(year), y = temp_xbar))+
  geom_boxplot(fill = NA)+
  geom_jitter(aes(x = factor(year), y = temp_xbar, color = site))+
  theme_classic()+
  labs(x = "Year", y = "Mean daily temperature, June 1 - Aug. 31", color = "Site Name")+
  theme(
    axis.title = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold"), 
    legend.position = "none", 
    strip.text = element_text(size = 11, face = "bold")
  )+
  scale_color_manual(values="purple")+
  facet_wrap(~source_name, scales = "free_y", nrow = 3, ncol =1)
wc.sum.boxplot
```

Stack and save:

```{r}
wc.stacked.box <- wc.aug.boxplot/wc.sum.boxplot
wc.stacked.box

ggsave("pres_figures/windcave_boxplot.pdf", wc.stacked.box, width = 8.5, height = 11, units = "in", device = "pdf", dpi = "retina")
```

#### 5b. Scatterplot + smooth for all data

Using tasr_dat for all continuous temp data: 

Data prep:

```{r}
tasr_daily<-tasr_dat%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"), 
         source_name = paste(source_print, full_name, sep = " - "))%>%
  group_by(date1, site, source, source_print, source_name)%>%
  summarise(t_xbar = mean(temp_raw), 
            t_min = min(temp_raw), 
            t_max = max(temp_raw))
  
```

Plotting:


```{r}
por.smooth <- ggplot(tasr_daily, aes(x = date1, y = t_xbar, color = source_name))+
  geom_point()+
  geom_smooth(se = F)+
  theme_classic()+
  scale_color_manual(values = boxplot.pal)+
  labs(x= "Date", y = "Mean daily temperature, C", color = "Site name")+
  facet_wrap(~source_print, nrow = 3, ncol = 1, scales = "free")+
  theme(
    axis.title = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold"), 
    legend.position = "bottom", 
    strip.text = element_text(size = 11, face = "bold")
  )
por.smooth
```

```{r}
ggsave("pres_figures/tasr_por_smooth.jpg", por.smooth, width = 8.5, height = 11, units = "in", device = "jpeg", dpi = "retina")
```

**Summer data only:**

```{r}
por.smooth.summer <- tasr_summer_doy%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"))%>%
  ggplot(aes(x = date1, y = temp_xbar, color = source_name))+
  geom_point()+
  geom_smooth(se = F)+
  theme_classic()+
  scale_color_manual(values = boxplot.pal)+
  labs(x= "Date", y = "Mean daily temperature (June-August), C", color = "Site name")+
  facet_wrap(~source_print, nrow = 3, ncol = 1, scales = "free")+
  theme(
    axis.title = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold"), 
    legend.position = "bottom", 
    strip.text = element_text(size = 11, face = "bold")
  )
por.smooth.summer
```

```{r}
ggsave("pres_figures/tasr_summer_smooth.jpg", por.smooth.summer, width = 8.5, height = 11, units = "in", device = "jpeg", dpi = "retina")
```

**August data only:**

```{r}
por.smooth.aug <- tasr_summer_doy%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"))%>%
  filter(month == 8)%>%
  ggplot(aes(x = date1, y = temp_xbar, color = source_name))+
  geom_point()+
  geom_smooth(se = F)+
  theme_classic()+
  scale_color_manual(values = boxplot.pal)+
  labs(x= "Date", y = "Mean daily temperature (August Only), C", color = "Site name")+
  facet_wrap(~source_print, nrow = 3, ncol = 1, scales = "free")+
  theme(
    axis.title = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold"), 
    legend.position = "bottom", 
    strip.text = element_text(size = 11, face = "bold")
  )
por.smooth.aug
```

```{r}
ggsave("pres_figures/tasr_aug_smooth.jpg", por.smooth.aug, width = 8.5, height = 11, units = "in", device = "jpeg", dpi = "retina")
```


#### 5b. Cumulative degree plots

Concept: Sum up all degrees >0 for each year, compare over time. 

First plot - all "degree hours" > 0C, color coded by site, panels for source:

```{r}
temp.lines <- tasr_dat%>%
  filter(temp_raw>0)%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"),
      source_name = paste(source_print, full_name, sep = " - "))%>%
  ggplot(aes(x = date1, y = temp_raw, color = source_name, fill = source_name))+
  geom_bar(stat = "identity", width = 0.01)+
  theme_classic()+
  scale_color_manual(values = boxplot.pal)+
  scale_fill_manual(values = boxplot.pal)+
  facet_wrap(~source_print, nrow = 3, ncol = 1)+
  labs(y = "Stream Temperature, C", x = "Date", color = "Site Name", fill = "Site Name")
temp.lines
```

Save:

```{r}
ggsave("pres_figures/temp_lines.jpg", temp.lines,  width = 8.5, height = 11, units = "in", device = "jpeg", dpi = "retina")
```


Calculate cumulative degrees above zero for each stream & year:

```{r}
tasr_cumulative_hourly <- tasr_dat%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"), #add print-friendly source types
      source_name = paste(source_print, full_name, sep = " - "))%>% #combined source + site name for plotting
  group_by(year, site, source_name, source_print)%>% #group by year + site, retain new naming columns for plotting
  summarise(temp_cum = sum((na.omit(temp_c)))) #calculate total "degree hours", = sum of ALL hourly temp readings >0 for each site/year combo. 
```

Plot:

```{r}
temps.cumulative <- ggplot(tasr_cumulative_hourly, aes(x = year, y = temp_cum, color = source_name))+ # set axes x = year, y= cumulative degree hours, color = source type /name combo
  geom_point()+
  geom_line()+ #add points for each year + line
  geom_smooth(method = "lm", linetype = "dashed", size = 0.4, se = F)+ #add dashed LM smooth to look at trends
  facet_wrap(~source_print, nrow = 3, ncol = 1)+ #facet wrap by source type
  scale_color_manual(values = boxplot.pal)+ #setting color pallate
  theme_classic()+ #removing extra formatting
  scale_x_continuous(breaks = c(2015, 2017, 2019, 2021, 2023))+ #updating/cleaning up X-axis labels
  labs(x = "Year", y = "Cumulative degree hours >0 C", color = "Stream Source & Name")+
  theme(
    axis.title = element_text(size = 11, face = "bold"),
    legend.title = element_text(size = 11, face = "bold"), 
    legend.position = "right", 
    strip.text = element_text(size = 11, face = "bold")
  )
temps.cumulative
```

Save:

```{r}
ggsave("pres_figures/thermalStress_line.jpg", temps.cumulative,  width = 8.5, height = 8.5, units = "in", device = "jpeg", dpi = "retina")
```


**One year of data all on one plot:**

Calculate daily mean temps: 

```{r}
tasr_daily <- tasr_dat %>%
  mutate(d = day(date1))%>%
  mutate(source_print = case_when(source == "sub_ice" ~ "Rock Glacier", source == "glacier" ~ "Glacier", source == "snowmelt" ~ "Snowfield"), 
         source_name = paste(source_print, full_name, sep = " - "))%>%
  group_by(site, d, source, full_name, year, date1, source_print, source_name)%>%
  summarise(temp_xbar = mean(temp_c, na.rm = T))
```

```{r}
tasr.20 <- ggplot(filter(tasr_daily, date1>"2021-01-01" & date1 < "2021-12-31"), aes(x = date1, y = temp_xbar, group = full_name, color = full_name))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Stream Temperature, C", color = "Stream Name")+
  theme(legend.position = "right", 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 10), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
tasr.20
```

Save:

```{r}
ggsave("pres_figures/tasr_2021.pdf", tasr.20, width = 12, height = 5, units = "in", device = "pdf", dpi = "retina")
```


**Two years in one plot**:

```{r}
tasr.21.22 <- ggplot(filter(tasr_daily, date1>"2021-01-01" & date1 < "2022-12-31"), aes(x = date1, y = temp_xbar, group = full_name, color = full_name))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Stream Temperature, C", color = "Stream Name")+
  theme(legend.position = "right", 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 10), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
tasr.21.22
```

Save:

```{r}
ggsave("pres_figures/tasr_21_22.pdf", tasr.21.22, width = 12, height = 5, units = "in", device = "pdf", dpi = "retina")
```


**One year, color coded by source:**

```{r}
tasr.source <- ggplot(filter(tasr_daily, date1>"2021-01-01" & date1 < "2021-12-31"), aes(x = date1, y = temp_xbar, group = full_name, color = source))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Stream Temperature, C", color = "Stream Name")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Rock Glacier"))+
  theme(legend.position = "right", 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 10), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
tasr.source
```

```{r}
ggsave("pres_figures/tasr_source.pdf", tasr.source, width = 12, height = 5, units = "in", device = "pdf", dpi = "retina")
```

---

### 5c. Yearly Temperature Profiles for all sites

Data = mean daily temps, June 1- Sep 30, TASR sites. 
Plots: x = date, y = mean daily temp, facet = site, color = year OR year*source?

Original Plot:

```{r}
source.yr.pal <- c(
  "#efedf5", "#e0dce6", "#ccc7d3", "#b8b2c0", "#a098a9", "#867c90", "#675b73", "#51435e", "#322241", "#130124", 
  "#a1d99b", "#95ce8f", "#85c07f", "#73b16e", "#5e9f59", "#498d45", "#347b30", "#236c1f", "#156011", "#055201", 
  "#fdae6b", "#eca161" , "#d99356", "#c4844a", "#b17640", "#9e6836", "#8a592a", "#75491e", "#5d3711", "#412201")
```

```{r}


temp.profiles <- tasr_daily%>%
  mutate(month = month(date1), 
         year = year(date1),
         doy = yday(date1), 
         doy_dt = as.Date(doy, origin = "2024-01-01"),
         year_src = paste(source_print, year, sep = " "))%>%
  filter(month>=6&month<=9)%>%
  ggplot(aes(x = doy_dt, y = temp_xbar, color = year_src))+
  geom_line()+
  facet_wrap(~source_name, nrow = 3)+
  #facet_grid(rows = vars(source_print), cols = vars(site))+
  scale_color_manual(values = source.yr.pal)+
  theme_classic()+
  scale_x_date(date_labels = "%b/%d")+
  labs(x = "Date", y = "Mean daily stream temperature, C", color = "Source type/year")+
  theme(
    axis.title = element_text(size=10, face="bold"), 
    strip.text = element_text(size = 9, face = "bold"), 
    legend.title = element_text(size = 10, face = "bold"), 
    axis.text.y = element_text(size = 9), 
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
    legend.text = element_text(size = 9)
  )

temp.profiles
```

Save:

```{r}
ggsave("Temperature/plots/temp_profiles.jpg", temp.profiles, device = "jpeg", units = "in", dpi = "retina", width = 11, height = 8.5)
```

Free Y Axis:

```{r}
temp.profiles.free <- tasr_daily%>%
  mutate(month = month(date1), 
         year = year(date1),
         doy = yday(date1), 
         doy_dt = as.Date(doy, origin = "2024-01-01"),
         year_src = paste(source_print, year, sep = " "))%>%
  filter(month>=6&month<=9)%>%
  ggplot(aes(x = doy_dt, y = temp_xbar, color = year_src))+
  geom_line()+
  facet_wrap(~source_name, scales = "free_y")+
  scale_color_manual(values = source.yr.pal)+
  theme_classic()+
  scale_x_date(date_labels = "%b/%d")+
  labs(x = "Date", y = "Mean daily stream temperature, C", color = "Source type/year")+
  theme(
    axis.title = element_text(size=10, face="bold"), 
    strip.text = element_text(size = 9, face = "bold"), 
    legend.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 9), 
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
    legend.text = element_text(size = 9)
  )

temp.profiles.free
```

Save:

```{r}
ggsave("Temperature/plots/temp_profiles_free.jpg", temp.profiles.free, device = "jpeg", units = "in", dpi = "retina", width = 11, height = 8.5)
```

Color gradient version w/rows by source:

```{r}
glacier.prof <- tasr_daily%>%
  mutate(month = month(date1), 
         year = year(date1),
         doy = yday(date1), 
         doy_dt = as.Date(doy, origin = "2024-01-01"),
         year_src = paste(source_print, year, sep = " "))%>%
  filter(month>=6&month<=9)%>%
  filter(source == "glacier")%>%
  ggplot(aes(x = doy_dt, y = t_xbar, color = year))+
  geom_line()+
  facet_wrap(~source_name, nrow = 1)+
  #facet_grid(rows = vars(source_print), cols = vars(site))+
  scale_color_gradient(low = "#EFEDF5", high = "#130124", 
                       breaks = c(2015, 2017, 2019, 2021, 2023), 
                       labels = c("2015", "2017", "2019", "2021", "2023"))+
  theme_classic()+
  scale_x_date(date_labels = "%b/%d")+
  labs(x = "Date", y = "Mean daily stream temperature, C", color = "Year (Glacier-fed Streams)")+
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    strip.text = element_text(size = 9, face = "bold"), 
    legend.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 9), 
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
    legend.text = element_text(size = 9)
  )

snow.prof <- tasr_daily%>%
  mutate(month = month(date1), 
         year = year(date1),
         doy = yday(date1), 
         doy_dt = as.Date(doy, origin = "2024-01-01"),
         year_src = paste(source_print, year, sep = " "))%>%
  filter(month>=6&month<=9)%>%
  filter(source == "snowmelt")%>%
  ggplot(aes(x = doy_dt, y = t_xbar, color = year))+
  geom_line()+
  facet_wrap(~source_name, nrow = 1)+
  #facet_grid(rows = vars(source_print), cols = vars(site))+
  scale_color_gradient(low = "#FDAE6B", high = "#412201", 
                       breaks = c(2015, 2017, 2019, 2021, 2023), 
                       labels = c("2015", "2017", "2019", "2021", "2023"))+
  theme_classic()+
  scale_x_date(date_labels = "%b/%d")+
  labs(x = "Date", y = "Mean daily stream temperature, C", color = "Year (Snowmelt-fed Streams)")+
  theme(
    axis.title.y = element_text(size=10, face="bold"), 
    axis.title.x = element_blank(),
    strip.text = element_text(size = 9, face = "bold"), 
    legend.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 9),     
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
    legend.text = element_text(size = 9)
  )

subice.prof <- tasr_daily%>%
  mutate(month = month(date1), 
         year = year(date1),
         doy = yday(date1), 
         doy_dt = as.Date(doy, origin = "2024-01-01"),
         year_src = paste(source_print, year, sep = " "))%>%
  filter(month>=6&month<=9)%>%
  filter(source == "sub_ice")%>%
  ggplot(aes(x = doy_dt, y = t_xbar, color = year))+
  geom_line()+
  facet_wrap(~source_name, nrow = 1)+
  #facet_grid(rows = vars(source_print), cols = vars(site))+
  scale_color_gradient(low = "#A1D99B", high = "#055201", 
                       breaks = c(2015, 2017, 2019, 2021, 2023), 
                       labels = c("2015", "2017", "2019", "2021", "2023"))+
  theme_classic()+
  scale_x_date(date_labels = "%b/%d")+
  labs(x = "Date", y = "Mean daily stream temperature, C", color = "Year (Subterranean Ice-fed Streams)")+
  theme(
    axis.title.x = element_text(size=10, face="bold"),
    axis.title.y = element_blank(),
    strip.text = element_text(size = 9, face = "bold"), 
    legend.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 9), 
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
    legend.text = element_text(size = 9)
  )

gradient.stacked.profiles <- glacier.prof/snow.prof/subice.prof
gradient.stacked.profiles
```


Save:

```{r}
ggsave("Temperature/plots/temp_profiles_gradient.jpg", gradient.stacked.profiles, device = "jpeg", units = "in", dpi = "retina", width = 11, height = 8.5)
```


####5d. Warm/Cold plots

Goal = faceted plot with 3 warm, 3 cold streams (temps stacked by years). 

* Warm streams = Grizzly, N Teton, S Teton (red, on bottom)
* Cold streams = Delta, Mid Teton, S Cascade (blue, on top)

```{r}
warmcold.pal <- c("#a1e2fa","#94ceec", "#86b8dd", "#7ba6d1", "#6b8dc0", "#5a72ad", "#49579b", "#383c88", "#282377", "#130260", "#fdae6b", "#eca161" , "#d99356", "#c4844a", "#b17640", "#9e6836", "#8a592a", "#75491e", "#5d3711", "#412201")

warmcold.lines <- tasr_daily%>%
  filter(site == "grizzly"|site=="n_teton"|site=="s_teton"|site=="delta"|site=="mid_teton"|site=="s_cascade")%>%
  mutate(month = month(date1), 
         year = year(date1),
         doy = yday(date1), 
         doy_dt = as.Date(doy, origin = "2024-01-01"),
         year_src = paste(source_print, year, sep = " "),
         strm_type = case_when(site == "s_cascade"~"Cold", site =="mid_teton"~"Cold", site == "delta"~"Cold", site == "grizzly"~"Warm", site=="n_teton"~"Warm", site == "s_teton"~"Warm"), 
         type_yr = paste(strm_type, year, sep = " - "), 
         site_type = paste(strm_type, full_name, sep = " - "))%>%
  filter(month>=6&month<=9)%>%
  ggplot(aes(x = doy_dt, y = temp_xbar, color = type_yr))+
  geom_line()+
  facet_wrap(~site_type, nrow = 2, ncol = 3)+
  #facet_grid(rows = vars(source_print), cols = vars(site))+
  scale_color_manual(values = warmcold.pal)+
  theme_classic()+
  scale_x_date(date_labels = "%b/%d")+
  labs(x = "Date", y = "Mean daily stream temperature, C", color = "Stream type & year")+
  theme(
    axis.title = element_text(size=10, face="bold"), 
    strip.text = element_text(size = 9, face = "bold"), 
    legend.title = element_text(size = 10, face = "bold"), 
    axis.text.y = element_text(size = 9), 
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
    legend.text = element_text(size = 9)
  )+
  guides(color = guide_legend(ncol = 2))

warmcold.lines
```

Save:

```{r}
ggsave("Temperature/plots/warm_cold_lines.jpg", warmcold.lines, device = "jpeg", units = "in", dpi = "retina", width = 8.5, height = 8.5)
```

## 6. Combine plot with full period of record for all sites; individual plots for each site (including below zero)

Combined plot - full period of record for all TASR sites in one graph: 

```{r}
tasr.full <- ggplot(tasr_dat, aes(x = date1, y = temp_raw, group = full_name, color = source))+
  geom_line()+
  theme_classic()+
  labs(x = "Date", y = "Stream Temperature, C", color = "Stream Source")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Rock Glacier"))+
  theme(legend.position = "right", 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 10), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
tasr.full
```

```{r}
ggsave("Temperature/plots/tasr_fullrecord.pdf", tasr.full, width = 9, height = 6.5, units = "in", device = "pdf", dpi = "retina")
```

Individual plots for each stream: 

Add columns with HTML color codes and print-friendly source names:

```{r}
tasr_dat1 <- tasr_dat%>%
  mutate(colorcode = case_when(
    source == "glacier"~pres.pal[1], 
    source == "snowmelt"~pres.pal[2],
    source == "sub_ice"~pres.pal[3]
  ), 
  source_print = case_when(
    source == "glacier"~"Glacier", 
    source == "snowmelt"~"Snowfield", 
    source == "sub_ice"~"Subterranean Ice"
  ))
```

Create vector with all tasr site names; initate empty list to recieve plots:

```{r}
stream.names <- unique(tasr_dat1$site)
plot.list<-list()
```

Create plot for each site in stream.names vector using a for loop; store in plot.list and save a pdf: 

```{r}
for(i in 1:length(stream.names)){
  dat<-tasr_dat1%>%
    filter(site == stream.names[i])
  p<-ggplot(dat, aes(x = date1, y = temp_raw, group = full_name))+
  geom_line(color = dat$colorcode)+
  theme_classic()+
  labs(x = "Date", y = "Stream Temperature, C", title = paste(dat$full_name, dat$source_print, sep = " - "))+
  theme(legend.position = "none", 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 10), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"), 
        plot.title = element_text(size =12, face = "bold", hjust = 0.5))
  plot.list[[i]]<-p
  fp<- paste("Temperature/plots/tasr_sites/", unique(dat$site), ".pdf", sep = "")
  ggsave(fp, p, device = "pdf", dpi = "retina", units = "in", height = 6.5, width = 9)
}
```

Save output .csv file: 

```{r}
write.csv(tasr_dat1, "Temperature/cleaned_full_datasets/tasr_inclNeg.csv")
```

---
---

## 7. Onset of Warming (Changepoint Analysis)


Example from online:
```{r}
# generate some test data
    set.seed(0)
    x <- seq(0,1,0.01)
    n <- length(x)
    sd <- rep(0.1,n)
    mu <- c(2*x[1:floor(n/2)],2 - 2*x[(floor(n/2)+1):n])
    y <- rnorm(n,mu,sd)
    
# use the locations in x
res <- cpop(y,x,beta=2*log(length(y)),sd=sd)
changepoints(res)
plot(res)
```


*Attempting with one spring (May 1 - Sep 1) of data from one stream: *

Notes:

* Probably need to do daily averages - not trying to get to hourly. 
* Maybe easier to use DOY instead of date for simplicity. 

Data prep & Initial plotting:

```{r}
tasr_test <- tasr_dat%>%
  filter(site=="n_teton"&date1>="2024-04-01"&date1<="2024-09-01")%>% #filter out data for Grizzly between April 1 and Aug 1 2024
  mutate(doy = yday(date1))%>%
  group_by(site, doy)%>%
  summarise(t_xbar = mean(temp_raw))%>%
  filter(!is.na(t_xbar))

#Plot to check for obvious step change(s):

ggplot(tasr_test, aes(x=doy, y =t_xbar))+
  geom_point()+
  theme_classic()
```

Attempt using cpop function:

```{r}
griz24.cpop <- cpop(tasr_test$t_xbar, tasr_test$doy, #providing y and x vectors for cpop function
                    beta =80) #adjusting beta value to increase penalty for adding more changepoints (default of 2*log(length(y)) (~9.8) was returning CP's before major step-change)
```

Check results - plot, extract changepoint:

```{r}
plot(griz24.cpop)+
  labs(title = unique(tasr_test$site))
changepoints(griz24.cpop)
changepoints(griz24.cpop)[1,1]
```

Take-aways: 

* Creates a bunch of changepoints - in first two tests, the first changepoint was the one we're looking for with beta set to 15. 
* Potential issue with picking beta - might not be super repeatable for sites/years with less clear break in slope. 
* Same goes for picking date range - changing date range changes # break points, but not position of major break points. 
* Some sites also have multiple "phases" of warming, one starting earlier in year and then a second ~early July

*General Workflow to iterate:*

Starting with tasr_dat - hourly data for all sites + years:

* Calculate daily mean temps, add DOY. 
* Extract desired site + year combo
* Filter desired date range *4/1-8/1*
+ NOTE - probably need to remove years that don't have data from this range. 
* Feed resulting data into cpop function wity y = t_xbar, x = doy. 
+ Set beta high (80?) to try and isolate most obvious breakpoints. 
* Extract first breakpoint and store along with site name and year.
* Save a plot of the output to check that correct breakpoint was extracted.

### A. Data Prep:

```{r}
tasr_doy <- tasr_dat %>%
  group_by(site, date1, source)%>% #group by site, date, and source
  summarise(t_xbar = mean(temp_raw))%>% #calculate mean daily temp
  mutate(doy = yday(date1), 
         year = year(date1), 
         site_yr = paste(site, year, sep = "_"))%>% #add columns for day of year, year, and site/year combo
  filter(doy>=92&doy<=245)%>% #extract DOY's 92-245 (April 1-Sep 1)
  filter(!is.na(t_xbar))%>% #remove days with missing temp readings
  group_by(site_yr)%>% #group by site year
  mutate(doyMin = min(doy), 
         doyMax = max(doy))%>% #add min and max DOY for each site/year combob
  ungroup()%>% #ungroup
  filter(!doyMin>92, 
         !doyMax<245)%>% #remove site/year combos with incomplete data or missing temp data
  arrange(source, site, doy)
```

### B. Iterate changepoint extraction over year/site with a for-loop:

Split data by site_yr:

```{r}
tasr_split <- split(tasr_doy, tasr_doy$site_yr)
```

For loop to extract CP's & save plots for each site/year:

```{r, warning = F, message=F}
site.yrs <- unique(tasr_doy$site_yr) #vector with unique values of site_yr
cps <- data.frame()#initiate empty df to receive cp data
cp.plots <- list()#initiate empty list to recieve cp plots

#For Loop:

for(i in 1:length(site.yrs)){
  t <- tasr_doy%>%
    filter(site_yr == site.yrs[i]) #extract data for year/site combo "i"
    #filter(doy>=92&doy<=245)%>% #extract data for ~April 1-Sept 1 based on 2024 DOY - may be off date-wise by a day for leap years
  
  c<-cpop(t$t_xbar, t$doy, beta = 80) #feeding temperature and doy data into cpop, setting beta to 80 
  cp<-changepoints(c)[1,1] #extract first changepoint
  cpp<-plot(c)+ #create plot of cp estimations
    labs(title = site.yrs[i], x = "day of yr", y = "temp, C") #add plot title w/site+year
  
  cpdf <- data.frame(unique(t$site), unique(t$year), unique(t$source), cp) #create dataframe with site, year, and dataframe
  cps<- rbind(cps, cpdf) #append to cps data frame
    
  
  cp.plots[[i]]<-cpp #store plot as "ith" item in plot list
  
  print(paste("completed ", i, "/", length(site.yrs), sep = ""))
}

cps<-cps%>%
  rename("site"=1, "year"=2, "source"=3, "cp_doy"=4)
```

Checking results:

```{r}
head(cps) #check output table
snowmelt.cps<-(cp.plots[[14]]|cp.plots[[15]]|cp.plots[[16]]|cp.plots[[17]])/(cp.plots[[18]]|cp.plots[[19]]|cp.plots[[20]]|cp.plots[[21]])/(cp.plots[[22]]|cp.plots[[23]]|cp.plots[[24]]|cp.plots[[25]])/(cp.plots[[26]]|cp.plots[[27]]|cp.plots[[28]])
snowmelt.cps #check CPS for all snowmelt sites
```

Generally pulling correct CP, with exception of N teton in 2019, 2020, and 2022

Save output plot:

```{r}
ggsave("Temperature/plots/snowmelt_changepoints.jpg", snowmelt.cps, device = "jpeg", units = "in", dpi = "retina", width = 11, height = 8.5)
```

Plot of change over time: 

```{r}
snowmelt.cp.trends <- ggplot(filter(cps, source == "snowmelt"), aes(x = year, y = cp_doy, color = site))+
  geom_point()+
  geom_line()+
  geom_smooth(method = "lm", se = F, linetype = "dashed")+
  theme_classic()+
  facet_wrap(~site)+
  theme(legend.position = "none", 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 10), 
        strip.text = element_text(size = 10, face = "bold"))+
  labs(x = "Year", y = "Onset of warming - day of year")+
  scale_color_manual(values = c("#d99356", "#c4844a", "#b17640"))
snowmelt.cp.trends
```

Save:

```{r}
ggsave("Temperature/plots/snowmelt_changepoint_trends.jpg", snowmelt.cp.trends, device = "jpeg", units = "in", dpi = "retina", width = 11, height = 8.5)
```

North Teton all over the place bc pulling earlier CP, both grizzly and S teton maybe downward trend (downward trend = warming onset earlier in the year)

