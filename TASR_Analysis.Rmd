---
title: "TASR Analysis"
author: "Gordon Gianniny"
date: "2023-06-26"
output: html_document
---

```{r, echo=FALSE}
#Loading Packages
library(tidyverse) #For data wrangling
library(lubridate) #For working with dates
library(ggplot2) #Plotting
library(RColorBrewer)
library(patchwork)
library(corrplot)
library(ggpp)
library(broom)
library(flextable)
library(maps) #mapping with ggplot2
library(ggmap) #for mapping w/google map basemaps
library(scales)
library(maptools)
library(raster)   ## To convert an "Extent" object to a "SpatialPolygons" object.
library(rgeos)

#Setting up ggmap API key: NOTE - for the map figures to work, you'll need to set up a Google Maps Platform Console Account at
#https://cloud.google.com/maps-platform/, create an API key, and store it in your .Renviron file as "GOOGLEMAPS_API_KEY". 

maps_api_key <- Sys.getenv("GOOGLEMAPS_API_KEY")
register_google(key = maps_api_key)

summarise<-dplyr::summarise
```

## Overview

This script reads in cleaned datafiles with stream temperature and invertebrate data produced by the invert_data_cleaning.Rmd and teton_data_cleaning.Rmd scripts and performs more involved analyses of stream temperature and invertebrate density/diversity over time. A few findings of interest from previous analyses are that: 

  * Average summer (July-Aug) stream temperatures have not changed significantly over time
    
  * Average summer (July-Aug) air temperatures have increased over time
    
  * Overall, invetebrate richness has not changed over time
    
  * Invertebrate communities in snow-fed streams appear to be more variable than those in glacier-fed streams

To build on these findings, the main sections of this script are: 

**I. Temperature:**
    
  1. Trends in summer mean, max, min, and degree-days over time: Site-by-site and grouped by source
    
  2. Modeling stream temperature using SNOTEL data: Site-by-site and grouped by source
    
  3. Linear mixed models of temperature over time
    
**II. Invertebrates:**

  1. Trends in richness, abundance, and density over time: Site-by-site and grouped by source
    
  2. Modeling richness, abundance, and density using SNOTEL data: Site-by-site and grouped by source
    
**III. Temperature and Invertebrates**

  1. Test for correlations between temperature metrics (mean/max/min summer; degree days): Site-by-site and grouped by source
    
Read in necessary files: 

```{r}
stream_temp <- read.csv("Temperature/cleaned_full_datasets/temps_hourly.csv") #hourly stream temp data
invert_density <- read.csv("invert_data/cleaned_csv/full_invert_densities.csv")%>%
  rename(site = Stream)#invert density data
invert_richness <- read.csv("invert_data/cleaned_csv/invert_richness.csv") #invert richness data
snotel <- read.csv("teton_snotel.csv") #snotel data
sources <- read.csv("source_info.csv")%>%
  rename(site = stream) #source info, rename for merge

### adding source info to stream temps and invert datasets: 

stream_source <- merge(stream_temp, sources, all = T)%>%
  mutate(date1 = ymd(date1), 
         year = year(date1))%>%
  filter(!is.na(temp_c))#Add source info to hourly temperature data; re-code date as r date format
stream_source_daily <- stream_source%>%
  group_by(site, full_name, stream_code, date1, year, lat, long)%>%
  summarise(t_xbar = mean(temp_c, na.rm = T), 
            t_max = max(temp_c, na.rm = T), 
            t_min = min(temp_c, na.rm = T), 
            t_range = t_max-t_min, 
            source = unique(source)) #calculate daily mean, min, and max temps for each site along with temp range
density_source <- merge(invert_density, sources, all = T)
richness_source <- merge(invert_richness, sources, all = T)
```





## I. Temperature:
    
### 1. Trends in summer mean, max, min, and degree-days over time

#### A. Site-by-site 

First, calculate summer (july-aug) mean daily temp, avg daily max and min; plus degree days over **15c?** for each site:

```{r}
stream_summer <- stream_source_daily %>%
  mutate(mo = month(date1))%>% #add month column
  filter(mo == 7 | mo == 8)%>% #extract July and August
  group_by(site, full_name, stream_code, year, lat, long)%>% #group by site and year
  summarise(summer_xbar = mean(t_xbar, na.rm = T), 
            max_xbar = mean(t_max, na.rm = T), 
            min_xbar = mean(t_min, na.rm= T), #calculate mean temperature, mean daily max and min
            range_xbar = mean(t_range, na.rm = T), #calculate mean daily temperature range
            dd_2.5 = length(which(t_max >= 2.5)), 
            dd_5 = length(which(t_max >= 5)),
            dd_10 = length(which(t_max >= 10)), #calculate no. days with max temp >2.5, 5, and 10 deg
            source = unique(source)) #retain source col
```

Next, extract sites with at least 3 years of data: 

```{r}
under3 <- stream_summer %>%
  group_by(site)%>% #group by site
  filter(!is.na(year))%>% #remove rows with no year
  summarise(n_yrs = length(unique(year)))%>% #count num unique years for site
  filter(n_yrs < 3) #extract sites with <3yrs data

summer_3plus <- stream_summer %>%
  filter(!site%in%under3$site)
```


**Trends in mean temp:**

Nest data by site: 

```{r}
summer_nested <- summer_3plus %>%
  filter(!is.na(year))%>%
  nest(data = -site)
```

lm for each site: 

```{r}
summer.mean.lms <- summer_nested %>%
  mutate(model = purrr::map(data, ~lm(summer_xbar~year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "year")  #remove intercept term to just get info on year for each site
summer.mean.lms
```

Nothing significant at 0.05 level; weakly significant increase in mean summer temp at S AK basin (p = 0.08)


Visualization: 

```{r}
summer_mean_withps <- merge(summer_3plus, summer.mean.lms)

pres.pal <- c("#C26ED6", "#F89225", "#76D96F")

summer.mean <- ggplot(summer_mean_withps, aes(x = year, y = summer_xbar, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.1, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Date", y = "Mean daily July-Aug. stream temp., C", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
summer.mean
```

**Mean daily max temp**

```{r}
summer.max.lms <- summer_nested %>%
  mutate(model = purrr::map(data, ~lm(max_xbar~year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "year")  #remove intercept term to just get info on year for each site
summer.max.lms
```

Significant increase at Skillet, non-significant increases at all but S cascade and mid teton

Visualization: 

```{r}
summer_max_withps <- merge(summer_3plus, summer.max.lms)

summer.max <- ggplot(summer_max_withps, aes(x = year, y = max_xbar, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.1, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Date", y = "Mean daily max. July-Aug. stream temp., C", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
summer.max
```

**Mean daily min temp**

```{r}
summer.min.lms <- summer_nested %>%
  mutate(model = purrr::map(data, ~lm(min_xbar~year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "year")  #remove intercept term to just get info on year for each site
summer.min.lms
```

Non-significant increases at all sites except south cascade

Visualization: 

```{r}
summer_min_withps <- merge(summer_3plus, summer.min.lms)

summer.min <- ggplot(summer_min_withps, aes(x = year, y = min_xbar, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.1, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Date", y = "Mean daily min. July-Aug. stream temp., C", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
summer.min
```

**Daily temperature fluctuation**

```{r}
summer.range.lms <- summer_nested %>%
  mutate(model = purrr::map(data, ~lm(range_xbar~year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "year")  #remove intercept term to just get info on year for each site
summer.range.lms
```

Non-significant increases at all sites except south cascade

Visualization: 

```{r}
summer_range_withps <- merge(summer_3plus, summer.range.lms)

summer.min <- ggplot(summer_range_withps, aes(x = year, y = range_xbar, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.1, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Date", y = "Mean daily July-Aug. stream temp. change, C", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
summer.min
```




**Degree Days**

Days over 2.5 C: 

```{r}
summer.2.5.lms <- summer_nested %>%
  mutate(model = purrr::map(data, ~lm(dd_2.5~year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "year")  #remove intercept term to just get info on year for each site
summer.2.5.lms
```

Non-significant increases at all sites except south cascade

Visualization: 

```{r}
summer_2.5_withps <- merge(summer_3plus, summer.2.5.lms)

summer.2.5 <- ggplot(summer_2.5_withps, aes(x = year, y = dd_2.5, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.1, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Date", y = "No. summer (July-Aug.) days with max temp >2.5 C", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
summer.2.5
```

Days over 5 C: 

```{r}
summer.5.lms <- summer_nested %>%
  mutate(model = purrr::map(data, ~lm(dd_5~year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "year")  #remove intercept term to just get info on year for each site
summer.5.lms
```

Non-significant increases at all sites except south cascade, mid teton, and delta (0 all years)

Visualization: 

```{r}
summer_5_withps <- merge(summer_3plus, summer.5.lms)

summer.5 <- ggplot(summer_5_withps, aes(x = year, y = dd_5, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.1, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Date", y = "No. summer (July-Aug.) days with max temp >5 C", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
summer.5
```

Days over 10 C: 

```{r}
summer.10.lms <- summer_nested %>%
  mutate(model = purrr::map(data, ~lm(dd_10~year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "year")  #remove intercept term to just get info on year for each site
summer.10.lms
```

Nothing significant. 

Visualization: 

```{r}
summer_10_withps <- merge(summer_3plus, summer.10.lms)

summer.10 <- ggplot(summer_10_withps, aes(x = year, y = dd_10, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.1, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Date", y = "No. summer (July-Aug.) days with max temp >10 C", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
summer.10
```

#### TABLE 1: Stream info

Make and save a table with stream names, years of data available for each, and stream source: 

First, table set-up:

```{r}
stream_info <- as.data.frame(summer_3plus) %>%
  dplyr::select(full_name, year, source)%>% #dplyr::select full name, year, and source columns
  group_by(full_name, source)%>% #group by full name and source
  summarise(range = paste(min(year, na.rm = T), max(year, na.rm = T), sep = "-"))%>% #add date range column for each stream
  arrange(source, full_name)%>% #sort by source then stream name
  mutate(source = case_when(source == "glacier"~"Glacier", source == "snowmelt"~"Snow melt", source == "sub_ice"~"Subterranean ice"))
```

Convert to FlexTable and export:

```{r}
tbl1 <- flextable(stream_info)%>%
  theme_vanilla()%>%
  align(part = "all", align = "left")%>%
  set_header_labels(full_name = "Stream Name", source = "Hydrologic Source", range = "Date Range")%>%
  set_table_properties(layout = "autofit")
tbl1
save_as_docx(tbl1,path = "manuscript/tables/table1_streaminfo.docx", align = "center")
save_as_image(tbl1,path = "manuscript/tables/table1_streaminfo.png", res = 300)
```

#### FIGURE 1: Map of sites used: 

```{r}
#Data set-up:
mean.long <- mean(summer_3plus$long, na.rm=T) 
mean.lat <- mean(summer_3plus$lat, na.rm =T) #calculate mean lat/long of all sites

map_dat <- as.data.frame(summer_3plus)%>%
  dplyr::select(full_name, source, lat, long)%>%
  distinct()%>%
  filter(!is.na(lat))

# Basemap: use get_map to pull map from google API:
basemap <- get_map(c(mean.long,mean.lat), #center map on mean lat and long of all sites
                   source = "stamen", zoom = 11, maptype = "terrain-background") #set map type and zoom

bb <- attr(basemap, "bb") #extract  max/min lat and long of the basemap for clipping

##GTNP boundary:
gtnp <- rgdal::readOGR("gis_data/gnp_gtnp")%>% #read in stored shapefile of GTNP and GNP polygons
  spTransform(crs("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")) #Update CRS to lat/long (comes in as UTM)

gtnp_clip <- crop(gtnp, extent(bb[1,2], bb[1,4], bb[1,1], bb[1,3]))%>% #Clip GTNP shapefile to the extent of the basemap
  fortify() #fortify to convert from SpatialPolygon to dataframe for plotting


```

Mapping:


```{r, warning=F}
site.map <- ggmap(basemap)+ #basemap: terrain background (no labels) from google maps platform console, centered on avg lat/long of all sites
  geom_polygon(data = gtnp_clip, aes(x = long, y = lat, group = group), color = "black", linetype = "dashed", fill = "darkgreen", alpha = 0.25, size = 0.6)+ #Adding clipped polygon of GTNP
  geom_point(data = map_dat, aes(x = long, y = lat, fill = source, group = NULL), color = "black", size = 3, pch = 21)+ #add  sites, color code by source 
  labs(color = "Hydrologic Source", fill = "Hydrologic Source")+ #updating legend title
  scale_fill_manual(values = pres.pal, labels = c("Glacier", "Snow melt", "Subterranean ice"))+
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 9, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 9), 
        legend.position = c(0.84, 0.12), #Moving legend into the plot area
        legend.background = element_rect(fill = "white", color = "black", size = 0.5), #adding box behind legend
        legend.margin = margin(t=5, r=5, b=5, l = 5, unit = "pt") #Increasing margins on legend box
        )+
  ggrepel::geom_label_repel(data=map_dat, aes(x=long, y = lat, label=full_name, fill = source), size =3.25, position = position_dodge(width = 1), fontface = "bold", show.legend = FALSE)+ #adding labels for each stream, color-coded by source
  geom_text_npc(aes(npcx = 0.84, npcy = 0.65, label = "Grand Teton \n National Park"), size = 4.5, fontface = 4, color = "black", hjust = 0.5, alpha = 0.25)+ #add label for Grand Teton NP
  geom_text_npc(aes(npcx = 0.2, npcy = 0.8, label = "Targhee \n National Forest"), size = 4.5, fontface = 4, color = "black", hjust = 0.5, alpha = 0.25) #add lable for Targhee NF
site.map
```

#### B. Grouped by source

First, group by source and re-calculate max, mean, min, and degree days: 

```{r}
summer_source <- stream_summer %>%
  group_by(source, year)%>% # group by source type and year
  summarise(t_xbar = mean(summer_xbar), 
            t_max = mean(max_xbar), 
            t_min = mean(min_xbar), #calculate mean daily temp, mean daily min and max
            t_range = mean(range_xbar),
            dd2.5_xbar = mean(dd_2.5), 
            dd5_xbar = mean(dd_5), 
            dd10_xbar = mean(dd_10),#calculate mean no. days with max temp >2.5, 5, and 10 C.
            n_sites = length(unique(site)))%>%  #calculate no sites for each year
  filter(!is.na(year), !is.na(source)
         #, !n_sites < 2
         )%>%
    mutate(source = case_when(source == "glacier"~"Glacier", source == "snowmelt"~"Snow melt", source == "sub_ice"~"Subterranean ice"))
```

##### i. Are there differences in min, max, avg temps between sources? 

Visualization: 

```{r}
source.means <- ggplot(summer_source, aes(x = source, y = t_xbar, fill = source))+
  geom_boxplot()+
  theme_classic()+
  scale_fill_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Subterranean Ice"))+
  theme(legend.position = "none")+
  labs(x = "", y = "Mean daily summer (July-Aug) temp., C")
source.max <- ggplot(summer_source, aes(x = source, y = t_max, fill = source))+
  geom_boxplot()+
  theme_classic()+
  scale_fill_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Subterranean Ice"))+
  theme(legend.position = "none")+
  labs(x = "Source", y = "Mean daily max. summer (July-Aug) temp., C")
source.min <- ggplot(summer_source, aes(x = source, y = t_max, fill = source))+
  geom_boxplot()+
  theme_classic()+
  scale_fill_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Subterranean Ice"))+
  theme(legend.position = "none")+
  labs(x = "", y = "Mean daily min. summer (July-Aug) temp., C")
source.means|source.max|source.min
```

Snow melt streams look to be significantly warmer and have higher max and mins - no surprise there. Check significance of these differences: 

```{r}
max.aov <- aov(t_xbar~source, data = summer_source)
summary(max.aov)
TukeyHSD(max.aov)
```

Snowmelt significantly warmer than sub-ice or glacier, no difference between sub-ice and glacier fed. 

##### ii. LMs of mean/min/max over time: 

First, visualization - re-organize data for easier plotting: 

```{r}
source_plot <- as.data.frame(summer_source) %>%
  dplyr::select(source, year, t_xbar, t_max, t_min, t_range)%>%
  pivot_longer(-c(source, year), names_to = "measure", values_to = "temp")
```

Plotting: 

```{r}
ylab <- expression(bold("Stream Temperature " (degree*C)))

source.summer <- ggplot(source_plot, aes(x = year, y = temp, color = measure))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~source, scales = "free_x")+
  scale_color_manual(values = c("darkred","darkblue", "darkorange","darkgreen" )
                     , labels = c("Max. temp.", "Min. temp.", "Temp. range", "Mean temp")
                     )+
  labs(x = "Date", y = ylab, color = "Measurement Type")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
source.summer
```

Test for significance: 

Nest plot data by source and measurement type:

```{r}
source_nested <- source_plot%>%
  nest(data = -c(source, measure))
```

Modeling:

```{r}
source.lms <- source_nested %>%
  mutate(model = purrr::map(data, ~lm(temp~year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "year")  #remove intercept term to just get info on year for each site
source.lms
```

Significant increases in min, mean, and max summer temp in glacier-fed streams, no change in snowmelt fed streams, non-significant increases in sub_ice streams.

Calculate degrees of warming per decade for each: 

```{r}
warming_amounts <- source.lms %>%
  mutate(deg_decade = 10*estimate)%>%
  dplyr::select(source, measure, deg_decade, p.value)%>%
  rename(Source = source, Measure = measure, Degrees.Warming = deg_decade, P = p.value)%>%
  mutate(Measure = case_when(Measure == "t_xbar"~"Mean", Measure == "t_min"~"Minimum", Measure == "t_max"~"Maximum", Measure == "t_range"~"Diel Temp Change"))
warming_amounts
```

#### TABLE 2: Deg. warming per decade

Convert to FlexTable and export: 

```{r}
tbl2<-flextable(warming_amounts)%>% #convert to flextable
  theme_vanilla()%>% #update theme to "vanilla"
  set_table_properties(align = "center", layout = "autofit")%>% #center align the table on the screen, autofit columns
  align(part = "all", align = "left")%>%#left align all text
  set_header_labels(Source = "Hydrologic Source", 
                    Measure = "Temperature Type", 
                    Degrees.Warming = "Change per decade, C", 
                    P = "P-value")
tbl2

save_as_image(tbl2, path = "manuscript/tables/degrees_warming.png", res = 300) #save as .png @ 300dpi
save_as_docx(tbl2, path ="manuscript/tables/degrees_warming.docx", align = "center") #save as .png @ 300dpi

```

Adding these P-values to the plot: 

#### FIGURE 2: Temp trends by source

```{r}
source_pvals <- merge(source.lms, summer_source)%>% #add model info to source dataframe
  mutate(ypos = case_when(measure == "t_max" ~ 0.95, measure == "t_xbar" ~ 0.9, measure == "t_min" ~ 0.85, measure == "t_range"~0.8)) #create column for adjusting P-value label Y position
  


source.summer.pv<- source.summer+
  geom_text_npc(data = source_pvals, aes(npcx = 0.1, npcy = ypos, color = measure, label = paste( "P = ",round(p.value, 3), sep = ""))) # add p value labels to plot
source.summer.pv
```

Save: 

```{r}
ggsave("Temperature/plots/source_summer.pdf", source.summer.pv, device = "pdf", units = "in", height = 5, width = 6.5, dpi = "retina")
```


##### iii. LMs of degree days over time: 

Re-organize data for easier plotting and modeling: 

```{r}
sourcedd_plot <- summer_source %>%
  dplyr::select(source, year, dd2.5_xbar, dd5_xbar, dd10_xbar)%>%
  pivot_longer(-c(source, year), names_to = "dd_type", values_to = "no_days")
```

Test for significance: 

Nest plot data by source and measurement type:

```{r}
sourcedd_nested <- sourcedd_plot%>%
  nest(data = -c(source, dd_type))
```

Modeling:

```{r}
sourcedd.lms <- sourcedd_nested %>%
  mutate(model = purrr::map(data, ~lm(no_days~year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "year")  #remove intercept term to just get info on year for each site
sourcedd.lms
```

No significant changes in degree days in any group. 

Plotting with these P-values: 

```{r}
sourcedd_pvals <- merge(sourcedd.lms, sourcedd_plot)%>% #add model info to source dataframe
  mutate(ypos = case_when(dd_type == "dd2.5_xbar" ~ 0.85, dd_type == "dd5_xbar" ~ 0.9, dd_type == "dd10_xbar" ~ 0.95)) #create column for adjusting P-value label Y position

sourcedd.summer<- ggplot(sourcedd_pvals, aes(x = year, y = no_days, color = dd_type))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~source, scales = "free_x")+
  scale_color_manual(values = c("darkred","orange", "darkorange"), labels = c(">10 C", ">2.5 C", ">5 C"))+
  labs(x = "Year", y = "Num. degree days", color = "Degree day threshold")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))+
  geom_text_npc(aes(npcx = 0.9, npcy = ypos, color = dd_type, label = paste( "P = ",round(p.value, 3), sep = ""))) # add p value labels to plot
sourcedd.summer
```

##### iv. Lumping glacier & snowmelt: 

First, combine glacier and snowmelt streams and recalculate mean, min, and max summer temperatures: 

```{r}
lumped_source <- stream_summer %>%
  mutate(source_lumped = ifelse(source == "sub_ice", "sub_ice", "other"))%>% #add new col with lumped sources
  filter(!is.na(year), !is.na(source))%>% #remove rows with no year or source
  group_by(source_lumped, year)%>% #group by lumped source and year
  summarise(t_xbar = mean(summer_xbar), #calculate mean, min, and max summer temps
            max_xbar = mean(max_xbar), 
            min_xbar = mean(min_xbar))%>%
  pivot_longer(!c(source_lumped, year), names_to = "measure", values_to = "temp") #pivot longer for plotting + analysis
```

Nest data by lumped source and measurement type: 

```{r}
lumped_nested <- lumped_source%>%
  nest(data = -c(source_lumped, measure))
```

lm for each source + year combo: 

```{r}
lumped.lms <- lumped_nested %>%
  mutate(model = purrr::map(data, ~lm(temp~year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "year")  #remove intercept term to just get info on year for each site
lumped.lms
```

Add p-values to data and plot: 

```{r}
lumped_pvals <- merge(lumped_source, lumped.lms)%>% #add model info to source dataframe
  mutate(ypos = case_when(measure == "t_xbar" ~ 0.9, measure == "max_xbar" ~ 0.95, measure == "min_xbar" ~ 0.85)) #create column for adjusting P-value label Y position

lumped.summer<- ggplot(lumped_pvals, aes(x = year, y = temp, color = measure))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~source_lumped, scales = "free_x")+
   scale_color_manual(values = c("darkred","darkblue", "darkgreen"), labels = c("Max. temp.", "Min. temp.", "Mean temp"))+
  labs(x = "Year", y = "Stream temperature, C", color = "Measurement Type")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))+
  geom_text_npc(aes(npcx = 0.1, npcy = ypos, color = measure, label = paste( "P = ",round(p.value, 3), sep = ""))) # add p value labels to plot
lumped.summer
```

```{r}
ggsave("Temperature/plots/lumped_summer.pdf", lumped.summer, device = "pdf", units = "in", height = 4, width = 6.5, dpi = "retina")
```

### 2. Modeling stream temperature using SNOTEL data

## STOPPING HERE 8/28 - NEED UPDATED SNOTEL DATA

First, calculate April 1 SWE and summer air temp from snotel data; add to mean temperature dataset: 

```{r}
#Calc means across both sites:
snotel_means <- snotel %>%
  mutate(date1 = as.Date(date, format = "%m/%d/%y"), #recode date column as R date
         airtemp_c = as.numeric(airtemp_c))%>% #recode airtemp as numeric
  group_by(date1)%>% #group by date
  summarise(swe_xbar = mean(swe_cm), #calculate mean SWE and airtemp across both stations
            airtemp_xbar = mean(airtemp_c, na.rm = T))%>%
  mutate(mo = month(date1), yr = year(date1)) #Add month and year cols

#Calculate max SWE and mean summer airtemp for each year:
snotel_summary <- snotel_means %>% 
  group_by(yr)%>% #group by year
  mutate(swe_max = max(swe_xbar), 
         swe_max_date = date1[which.max(swe_xbar)], 
         swe_zero_date = date1[which.min(swe_xbar)][1])%>% #extract max SWE and add to new col
  ungroup()%>% #ungroup to get all columns back
  filter(mo == 7 | mo == 8)%>% #extract summer months
  group_by(yr)%>% #group by year
  summarise(airtemp_summer = mean(airtemp_xbar), #calculate mean summer air temp
            swe_max = unique(swe_max), 
            swe_max_date = ymd(unique(swe_max_date)), 
            swe_zero_date =ymd(unique(swe_zero_date)))%>% #keep max SWE
  mutate(melt_days = as.numeric(swe_zero_date-swe_max_date))%>%
  rename(year = yr)

#Merge with long-term temperature averages: 
stream_snotel <- merge(summer_3plus, snotel_summary)
```

#### A. Site-by-site 

##### i. Correlations between SWE and Summer Temp: 

LMs - first, nest by site: 

```{r}
stream_snotel_nested <- stream_snotel %>%
  nest(data = - site)
```

lm for each site: 

```{r}
swe.temp.lms <- stream_snotel_nested %>%
  mutate(model = purrr::map(data, ~lm(summer_xbar~swe_max, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "swe_max")  #remove intercept term to just get info on year for each site
swe.temp.lms
```

Add P values and merge:

```{r}
swe_summer_ps <- merge(swe.temp.lms, stream_snotel)

swe.summer.temp <- ggplot(swe_summer_ps, aes(x = swe_max, y = summer_xbar, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Annual maxium SWE, cm", y = "Mean daily July-Aug. stream temp., C", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
swe.summer.temp
```

##### ii. Summer stream temp ~ summer air temp:

lm for each site: 

```{r}
air.temp.lms <- stream_snotel_nested %>%
  mutate(model = purrr::map(data, ~lm(summer_xbar~airtemp_summer, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "airtemp_summer")  #remove intercept term to just get info on year for each site
air.temp.lms
```

Add P values and plot:

```{r}
air_summer_ps <- merge(air.temp.lms, stream_snotel)

swe.summer.temp <- ggplot(air_summer_ps, aes(x = airtemp_summer, y = summer_xbar, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Mean daily July-Aug. air temp, C", y = "Mean daily July-Aug. stream temp., C", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
swe.summer.temp
```

##### iii. Summer stream temp ~ meltout length (days):

lm for each site: 

```{r}
melt.temp.lms <- stream_snotel_nested %>%
  mutate(model = purrr::map(data, ~lm(summer_xbar~melt_days, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "melt_days")  #remove intercept term to just get info on year for each site
melt.temp.lms
```

Add P values and plot:

```{r}
melt_summer_ps <- merge(melt.temp.lms, stream_snotel)

melt.summer.temp <- ggplot(melt_summer_ps, aes(x = melt_days, y = summer_xbar, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Mean daily July-Aug. air temp, C", y = "Mean daily July-Aug. stream temp., C", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
melt.summer.temp
```



#### B. Grouped by source

First, add SNOTEL summary info to mean summer temps grouped by source: 

```{r}
source_snotel <- merge(summer_source, snotel_summary)
```

##### i. LMs of mean/min/max temp ~ SWE: 

Re-organize data for analysis and plotting: 

```{r}
source_swe <- source_snotel %>%
  dplyr::select(source, swe_max, t_xbar, t_min, t_max, t_range)%>% #dplyr::select temperature, source, and swe cols
  pivot_longer(!c(source, swe_max), names_to = "measure", values_to = "temp") #pivot longer for plotting + analysis
```

Nest data by source and measure: 

```{r}
sourceSwe_nested <- source_swe %>%
  nest(data = -c(source, measure))
```

LMs for each source and measure: 

```{r}
source.swe.lms <- sourceSwe_nested %>%
  mutate(model = purrr::map(data, ~lm(temp~swe_max, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "swe_max")  #remove intercept term to just get info on year for each site
source.swe.lms
```

Add p-values and plot: 

```{r}
sourceSwe_pval<-merge(source_swe, source.swe.lms)%>%
  mutate(ypos = case_when(measure == "t_xbar" ~ 0.9, measure == "t_max" ~ 0.95, measure == "t_min" ~ 0.85, measure == "t_range"~0.8)) #create column for adjusting P-value label Y position

source.swe<- ggplot(sourceSwe_pval, aes(x = swe_max, y = temp, color = measure))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~source, scales = "free_x")+
   scale_color_manual(values = c("darkred","darkblue", "darkorange","darkgreen"), labels = c("Max. temp.", "Min. temp.", "Temp. range", "Mean temp"))+
  labs(x = "Annual maximum SWE, cm", y = "Stream temperature, C", color = "Measurement Type")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))+
  geom_text_npc(aes(npcx = 0.9, npcy = ypos, color = measure, label = paste( "P = ",round(p.value, 3), sep = ""))) # add p value labels to plot
source.swe
```

Save:

```{r}
ggsave("Temperature/plots/source_swe.pdf", source.swe, device = "pdf", units = "in", height = 4, width = 6.5, dpi = "retina")
```

##### ii. LMs of mean/min/max temp ~ Air temp: 

Re-organize data for analysis and plotting: 

```{r}
source_air <- source_snotel %>%
  dplyr::select(source, airtemp_summer, t_xbar, t_min, t_max, t_range)%>% #dplyr::select temperature, source, and swe cols
  pivot_longer(!c(source, airtemp_summer), names_to = "measure", values_to = "temp") #pivot longer for plotting + analysis
```

Nest data by source and measure: 

```{r}
sourceAir_nested <- source_air %>%
  nest(data = -c(source, measure))
```

LMs for each source and measure: 

```{r}
source.air.lms <- sourceAir_nested %>%
  mutate(model = purrr::map(data, ~lm(temp~airtemp_summer, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "airtemp_summer")  #remove intercept term to just get info on year for each site
source.air.lms
```

Add p-values and plot: 

```{r}
sourceAir_pval<-merge(source_air, source.air.lms)%>%
  mutate(ypos = case_when(measure == "t_xbar" ~ 0.9, measure == "t_max" ~ 0.95, measure == "t_min" ~ 0.85, measure == "t_range"~0.8)) #create column for adjusting P-value label Y position

source.air<- ggplot(sourceAir_pval, aes(x = airtemp_summer, y = temp, color = measure))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~source, scales = "free_x")+
   scale_color_manual(values = c("darkred","darkblue", "darkorange","darkgreen"), labels = c("Max. temp.", "Min. temp.", "Temp. range", "Mean temp"))+
  labs(x = "Annual maximum SWE, cm", y = "Stream temperature, C", color = "Measurement Type")+
  labs(x = "Mean July-Aug. air temp., C", y = "Stream temperature, C", color = "Measurement Type")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))+
  geom_text_npc(aes(npcx = 0.1, npcy = ypos, color = measure, label = paste( "P = ",round(p.value, 3), sep = ""))) # add p value labels to plot
source.air
```

Save:

```{r}
ggsave("Temperature/plots/source_air.pdf", source.air, device = "pdf", units = "in", height = 4, width = 6.5, dpi = "retina")
```

##### iii. LMs of mean/min/max temp ~ Meltout length: 

Re-organize data for analysis and plotting: 

```{r}
source_melt <- source_snotel %>%
  dplyr::select(source, melt_days, t_xbar, t_min, t_max, t_range)%>% #dplyr::select temperature, source, and swe cols
  pivot_longer(!c(source, melt_days), names_to = "measure", values_to = "temp") #pivot longer for plotting + analysis
```

Nest data by source and measure: 

```{r}
sourceMelt_nested <- source_melt %>%
  nest(data = -c(source, measure))
```

LMs for each source and measure: 

```{r}
source.melt.lms <- sourceMelt_nested %>%
  mutate(model = purrr::map(data, ~lm(temp~melt_days, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "melt_days")  #remove intercept term to just get info on year for each site
source.melt.lms
```

Add p-values and plot: 

```{r}
sourceMelt_pval<-merge(source_melt, source.melt.lms)%>%
  mutate(ypos = case_when(measure == "t_xbar" ~ 0.9, measure == "t_max" ~ 0.95, measure == "t_min" ~ 0.85, measure == "t_range"~0.8)) #create column for adjusting P-value label Y position

source.melt<- ggplot(sourceMelt_pval, aes(x = melt_days, y = temp, color = measure))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~source, scales = "free_x")+
   scale_color_manual(values = c("darkred","darkblue", "darkorange","darkgreen"), labels = c("Max. temp.", "Min. temp.", "Temp. range", "Mean temp"))+
  labs(x = "Annual maximum SWE, cm", y = "Stream temperature, C", color = "Measurement Type")+
  labs(x = "Days from peak SWE to zero SWE", y = "Stream temperature, C", color = "Measurement Type")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))+
  geom_text_npc(aes(npcx = 0.1, npcy = ypos, color = measure, label = paste( "P = ",round(p.value, 3), sep = ""))) # add p value labels to plot
source.melt
```

Save:

```{r}
ggsave("Temperature/plots/source_meltout.pdf", source.melt, device = "pdf", units = "in", height = 4, width = 6.5, dpi = "retina")
```

### 3. Linear mixed models of temperature over time

General concept: want to test a linear mixed model of stream temperature (min, max, mean, and range) with: 

  * Fixed effects: 
    * Year
    * Max SWE
    * Max SWE day of year
    * Mean summer air temp
    * Meltout length (days)
  * Random intercept for Site

Current approach will be to run seperate models for each different source type. 

Calculate day of year for max SWE and zero SWE: 

```{r}
stream_snotel1 <- stream_snotel%>%
  mutate(swe_max_doy =yday(swe_max_date), 
         swe_zero_doy=yday(swe_zero_date))
```
  
#### A. Testing for correlation between predictor variables: 

Extract predictor variables:

```{r}
predictors <- stream_snotel1%>%
  dplyr::select(year, airtemp_summer, swe_max, melt_days, swe_max_doy, swe_zero_doy)%>%
  distinct()
```

Calculate correlation matrix and melt for plotting: 

```{r}
cormat <-round(cor(predictors), 2)
cormat[upper.tri(cormat)]<- NA
cormat_melt<-reshape2::melt(cormat, na.rm = T)
cormat_melt
```

Plot correlation matrix: 

```{r}
ggplot(cormat_melt, aes(x = Var1, y = Var2, fill = value))+
  geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Pearson\nCorrelation") +
  theme_minimal()+ 
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 10, hjust = 1), 
    axis.text.y = element_text(
    size = 10),
    axis.title = element_blank())+
 coord_fixed()+
  geom_text(aes(label = value))
```

Using a threshold of **0.5**, correlations are: 

  * melt_days~swe_max_doy
  * melt_days~swe_zero_doy
  * swe_zero_doy~swe_max
  * airtemp_summer~swe_max_doy
  * airtemp_summer~year
  * swe_max_doy~year

Problematic variables are swe max/zero DOY, year. For now, dropping year (more relevant info contained in summer air temperature) and Swe max/zero DOY (info from both is roughly contained in melt_days)

Confirming that remaining variables don't have correlations greater than 0.5: 

```{r}
cormat_filter <- cormat_melt%>%
  filter(!(Var1 == "year"|Var1=="swe_max_doy"|Var1=="swe_zero_doy"),
         !(Var2 == "year"|Var2=="swe_max_doy"|Var2=="swe_zero_doy"))

ggplot(cormat_filter, aes(x = Var1, y = Var2, fill = value))+
  geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Pearson\nCorrelation") +
  theme_minimal()+ 
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 10, hjust = 1), 
    axis.text.y = element_text(
    size = 10),
    axis.title = element_blank())+
 coord_fixed()+
  geom_text(aes(label = value))
```

#### B. Checking distribution of the response variables

Data prep for plotting & modeling:

```{r}
lmm_pivot <- stream_snotel1 %>%
  dplyr::select(max_xbar, min_xbar, range_xbar, summer_xbar, source, airtemp_summer, swe_max, melt_days, site, year)%>%
  pivot_longer(!c(source, airtemp_summer, swe_max, melt_days, site, year), names_to = "measure", values_to = "temp_c")%>%
  mutate(transform = log10(temp_c))

#for plotting model results: 

lmm_plot <- lmm_pivot%>%
  pivot_longer(!c(source, site, year, measure, temp_c, transform), names_to = "predictor_name", values_to = "predictor_value")
```

Check distribution of response variables: 

```{r}
#without log10 transform:
ggplot(lmm_pivot, aes(x = temp_c))+
  geom_density(fill = "grey", color = "black")+
  facet_wrap(~measure)+
  theme_classic()

#with log10 transform:
ggplot(lmm_pivot, aes(x = transform))+
  geom_density(fill = "grey", color = "black")+
  facet_wrap(~measure)+
  theme_classic()

```

All are left-skewed, but a log transform just makes them left-skewed. Skipping log transform for now. 

#### C. Running LMMs

Load packages: 

```{r}
library(lme4)
library(lmerTest)
```

Nest data by source: 

```{r}
lmm_nested <- lmm_pivot%>%
  nest(data = -c(source, measure))
```

##### i. Maximum temp:

Run LMM for each source and measure - form: 

(t_max, t_min, t_range, t_ave) ~ airtemp_summer + swe_max + melt_days + random(site)

```{r}
max_temps <- filter(lmm_nested, measure == "max_xbar")

max.lmm <- max_temps %>%
  mutate(model = purrr::map(data, ~lmerTest::lmer(temp_c~melt_days+airtemp_summer+swe_max+(1|site), data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     broom.mixed::tidy(effects="fixed", conf.int = TRUE)))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model)%>% #unnest model column to get rows for each site, columns for model metrics
  mutate(p.value = round(p.value, 4))%>%
  filter(!term == "(Intercept)")%>%
  dplyr::select(source, term, estimate, std.error, statistic, df, p.value)
max.lmm
```

Results: 

*Subterranean ice:*

Significant negative correlation between summer air temp and max stream temp (maybe more ice melting?)

*Snowmelt:* 

Significant negative correlation between melt length and max temp; same with summer air temp and max temp (??)

*Glacier:*

No significant effects. 

Visualization: 

```{r}
ggplot(filter(lmm_plot, measure == "max_xbar"), aes(x = predictor_value, y = temp_c, color = source, group = site))+
  geom_point(size = 0.5)+
  geom_line(size = 0.5)+
  geom_smooth(aes(group = NULL), method = "lm", se = T, linetype = "dashed", color = "black", size = 0.5)+
  theme_classic()+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  facet_grid(source~predictor_name, scales = "free")+
  theme(legend.position = "none")+
  labs(x = "Predictor Value", y = "Mean maximum July-Aug stream temp, C")
```

##### ii. Minimum temp:

Run LMM for each source and measure - form: 

(t_max, t_min, t_range, t_ave) ~ airtemp_summer + swe_max + melt_days + random(site)

```{r}
min_temps <- filter(lmm_nested, measure == "min_xbar")

min.lmm <- min_temps %>%
  mutate(model = purrr::map(data, ~lmerTest::lmer(temp_c~melt_days+airtemp_summer+swe_max+(1|site), data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     broom.mixed::tidy(effects="fixed", conf.int = TRUE)))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model)%>% #unnest model column to get rows for each site, columns for model metrics
  mutate(p.value = round(p.value, 4))%>%
  filter(!term == "(Intercept)")%>%
  dplyr::select(source, term, estimate, std.error, statistic, df, p.value)
min.lmm
```

Results: 

*Subterranean ice:*

Significant negative correlation between maximum SWE and min summer stream temp (Maybe less ice melting bc of snow insulation?)

*Snowmelt:* 

Significant negative correlation between melt length, summer air temp, and swe max and summer stream temp. Melt length makes sense, others don't really...

*Glacier:*

No significant effects. 

Visualization: 

```{r}
ggplot(filter(lmm_plot, measure == "min_xbar"), aes(x = predictor_value, y = temp_c, color = source, group = site))+
  geom_point(size = 0.5)+
  geom_line(size = 0.5)+
  geom_smooth(aes(group = NULL), method = "lm", se = T, linetype = "dashed", color = "black", size = 0.5)+
  theme_classic()+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  facet_grid(source~predictor_name, scales = "free")+
  theme(legend.position = "none")+
  labs(x = "Predictor Value", y = "Mean minimum July-Aug stream temp, C")
```

##### iii. Average temp:

Run LMM for each source and measure - form: 

(t_max, t_min, t_range, t_ave) ~ airtemp_summer + swe_max + melt_days + random(site)

```{r}
mean_temps <- filter(lmm_nested, measure == "summer_xbar")

mean.lmm <- mean_temps %>%
  mutate(model = purrr::map(data, ~lmerTest::lmer(temp_c~melt_days+airtemp_summer+swe_max+(1|site), data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     broom.mixed::tidy(effects="fixed", conf.int = TRUE)))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model)%>% #unnest model column to get rows for each site, columns for model metrics
  mutate(p.value = round(p.value, 4))%>%
  filter(!term == "(Intercept)")%>%
  dplyr::select(source, term, estimate, std.error, statistic, df, p.value)
mean.lmm
```

Results: 

*Subterranean ice:*

Significant negative correlation between summer air temp and mean summer stream temp (Maybe less ice melting bc of snow insulation?)

*Snowmelt:* 

Significant negative correlation between melt length, summer air temp, and swe max and summer stream temp. Melt length makes sense, others don't really...

*Glacier:*

No significant effects.

Visualization: 

```{r}
ggplot(filter(lmm_plot, measure == "summer_xbar"), aes(x = predictor_value, y = temp_c, color = source, group = site))+
  geom_point(size = 0.5)+
  geom_line(size = 0.5)+
  geom_smooth(aes(group = NULL), method = "lm", se = T, linetype = "dashed", color = "black", size = 0.5)+
  theme_classic()+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  facet_grid(source~predictor_name, scales = "free")+
  theme(legend.position = "none")+
  labs(x = "Predictor Value", y = "Mean daily July-Aug stream temp, C")
```

##### iv. temp range:

Run LMM for each source and measure - form: 

(t_max, t_min, t_range, t_ave) ~ airtemp_summer + swe_max + melt_days + random(site)

```{r}
temp_ranges <- filter(lmm_nested, measure == "range_xbar")

range.lmm <- temp_ranges %>%
  mutate(model = purrr::map(data, ~lmerTest::lmer(temp_c~melt_days+airtemp_summer+swe_max+(1|site), data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     broom.mixed::tidy(effects="fixed", conf.int = TRUE)))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model)%>% #unnest model column to get rows for each site, columns for model metrics
  mutate(p.value = round(p.value, 4))%>%
  filter(!term == "(Intercept)")%>%
  dplyr::select(source, term, estimate, std.error, statistic, df, p.value)
range.lmm
```

Results: 

*Subterranean ice:*

Marginally significant negative correlation between summer air temp and temperature variability (warmer summers = less variability)

*Snowmelt:* 

Significant negative correlation of melt length and summer air temp with temperature variability (longer melt and warmer summers = less variability). Seems a bit contradictory.

*Glacier:*

No significant effects.

Visualization: 

```{r}
ggplot(filter(lmm_plot, measure == "range_xbar"), aes(x = predictor_value, y = temp_c, color = source, group = site))+
  geom_point(size = 0.5)+
  geom_line(size = 0.5)+
  geom_smooth(aes(group = NULL), method = "lm", se = T, linetype = "dashed", color = "black", size = 0.5)+
  theme_classic()+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  facet_grid(source~predictor_name, scales = "free")+
  theme(legend.position = "none")+
  labs(x = "Predictor Value", y = "Mean July-Aug daily stream temp. change, C")
```

## II. Invertebrates:

### 1. Trends in richness, abundance, and density over time

#### A. Site-by-site 

First, calculate richness, mean density, and total abundance for each site for each year; remove sites with only 1 year of data: 

```{r}
oneYr <- density_source%>%
  group_by(site)%>% #group by site
  summarise(nYrs = length(unique(Year)))%>% #count no. years
  filter(nYrs <3) #extract sites w/ only 1-2 yrs data


invert_means <- density_source %>%
  group_by(stream_code, full_name, site, Year)%>% #group by stream and year
  summarise(richness = length(unique(taxa_lwr)),  #calculate yearly richness, density, and total abundance
            density_xbar = mean(density_xbar), 
            tot_abund = sum(abundance_total), 
            source = unique(source))%>%
  filter(!site%in%oneYr$site) #drop sites with 1-2yrs of data
```

##### i. LM's of Richness ~ year at each site: 

First, nest data by site: 

```{r}
invert_nested <- invert_means %>%
  nest(data = -site)
```

LM's of Richness ~ year for each site: 

```{r}
richness.yr.lm <- invert_nested %>%
  mutate(model = purrr::map(data, ~lm(richness~Year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "Year")  #remove intercept term to just get info on year for each site
richness.yr.lm
```

Add p-values and plot: 

```{r}
richness_withps <- merge(invert_means, richness.yr.lm)

pres.pal <- c("#C26ED6", "#F89225", "#76D96F")

richness.yr <- ggplot(richness_withps, aes(x = Year, y = richness, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Date", y = "Taxonomic richness", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
richness.yr
```

Significant decline in richness at S Cascade, non-significant declines at most other sites 

Save:

```{r}
ggsave("invert_data/plots/richness_year.pdf", richness.yr, device = "pdf", dpi = "retina", units = "in", height = 5, width = 6.5)
```

##### ii. LM's of Density ~ year at each site: 


LM's of Density ~ year for each site: 

```{r}
dens.yr.lm <- invert_nested %>%
  mutate(model = purrr::map(data, ~lm(density_xbar~Year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "Year")  #remove intercept term to just get info on year for each site
dens.yr.lm
```

Add p-values and plot: 

```{r}
density_withps <- merge(invert_means, dens.yr.lm)

pres.pal <- c("#C26ED6", "#F89225", "#76D96F")

dens.yr <- ggplot(density_withps, aes(x = Year, y = density_xbar, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Date", y = "Mean density, individuals/m2", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
dens.yr
```

No significant trends in average density at any site

Save:

```{r}
ggsave("invert_data/plots/density_year.pdf", dens.yr, device = "pdf", dpi = "retina", units = "in", height = 5, width = 6.5)
```

##### iii. LM's of total abundance ~ year at each site: 


LM's of Density ~ year for each site: 

```{r}
abund.yr.lm <- invert_nested %>%
  mutate(model = purrr::map(data, ~lm(tot_abund~Year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "Year")  #remove intercept term to just get info on year for each site
abund.yr.lm
```

Add p-values and plot: 

```{r}
abund_withps <- merge(invert_means, abund.yr.lm)

pres.pal <- c("#C26ED6", "#F89225", "#76D96F")

abund.yr <- ggplot(density_withps, aes(x = Year, y = tot_abund, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~full_name, scales = "free")+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Date", y = "Total abundance", color = "Stream Source")+
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
abund.yr
```

No significant trends in total abundance at any site. 

Save:

```{r}
ggsave("invert_data/plots/abundance_year.pdf", abund.yr, device = "pdf", dpi = "retina", units = "in", height = 5, width = 6.5)
```

#### B. Grouped by source

First, group by source and calculate mean richness, density, and abundance: 

```{r}
source_inverts <- invert_means %>%
  group_by(source, Year)%>%
  summarise(richness_xbar = mean(richness), 
            density_xbar = mean(density_xbar),
            abund_xbar = mean(tot_abund))
```

##### i. LMs of richness ~ year for each source:

First, nest data by source:

```{r}
source_inverts_nested <- source_inverts %>%
  nest(data = -source)
```

LMs of richness ~ year for each source:

```{r}
ricness.source.lm <- source_inverts_nested %>%
  mutate(model = purrr::map(data, ~lm(richness_xbar~Year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "Year")  #remove intercept term to just get info on year for each site
ricness.source.lm
```

Add p-values and plot: 

```{r}
richnessSource_pv <- merge(source_inverts, ricness.source.lm)

pres.pal <- c("#C26ED6", "#F89225", "#76D96F")

richness.source <- ggplot(richnessSource_pv, aes(x = Year, y = richness_xbar, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~source)+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.95, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Year", y = "Mean taxonomic richness", color = "Stream Source")+
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
richness.source
```

Significant decline in richness at subterranean ice sites

Save:

```{r}
ggsave("invert_data/plots/richness_source.pdf", richness.source, device = "pdf", dpi = "retina", units = "in", height = 5, width = 6.5)
```


##### ii. LMs of density ~ year for each source:

LMs of density ~ year for each source:

```{r}
dens.source.lm <- source_inverts_nested %>%
  mutate(model = purrr::map(data, ~lm(density_xbar~Year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "Year")  #remove intercept term to just get info on year for each site
dens.source.lm
```

Add p-values and plot: 

```{r}
densSource_pv <- merge(source_inverts, dens.source.lm)

pres.pal <- c("#C26ED6", "#F89225", "#76D96F")

dens.source <- ggplot(densSource_pv, aes(x = Year, y = density_xbar, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~source)+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.95, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Year", y = "Mean density, individuals/m2", color = "Stream Source")+
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
dens.source
```

No significant trends in average density in any source. 

Save:

```{r}
ggsave("invert_data/plots/density_source.pdf", dens.source, device = "pdf", dpi = "retina", units = "in", height = 5, width = 6.5)
```

##### iii. LMs of abundance ~ year for each source:

LMs of abundance ~ year for each source:

```{r}
abund.source.lm <- source_inverts_nested %>%
  mutate(model = purrr::map(data, ~lm(abund_xbar~Year, data = .)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "Year")  #remove intercept term to just get info on year for each site
abund.source.lm
```

Add p-values and plot: 

```{r}
abundSource_pv <- merge(source_inverts, abund.source.lm)

pres.pal <- c("#C26ED6", "#F89225", "#76D96F")

abund.source <- ggplot(abundSource_pv, aes(x = Year, y = abund_xbar, color = source))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  facet_wrap(~source)+
  scale_color_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Icy Seep"))+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.95, label = paste( "P = ",round(p.value, 2), sep = "")))+
  labs(x = "Year", y = "Mean density, individuals/m2", color = "Stream Source")+
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 8), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))
abund.source
```

No significant trends in average abundance in any source. 

Save:

```{r}
ggsave("invert_data/plots/abundance_source.pdf", abund.source, device = "pdf", dpi = "retina", units = "in", height = 5, width = 6.5)
```


### 2. Modeling richness, abundance, and density using SNOTEL data

#### A. Site-by-site 

#### B. Grouped by source
    
## III. Temperature and Invertebrates

### 1. Test for correlations between temperature metrics (mean/max/min summer; degree days)

#### A. Site-by-site 

#### B. Grouped by source
    

