---
title: "Invert Data Cleaning"
author: "Gordon Gianniny"
date: "2023-04-21"
output: html_document
---

```{r, echo=FALSE}
#Loading Packages
library(tidyverse) #For data wrangling
library(lubridate) #For working with dates
library(ggplot2) #Plotting
library(RColorBrewer)
library(patchwork)
library(stringr)
library(vegan)
library(broom)
library(sp)
```

## Overview

This script cleans and visualizes Invert data from the TASR monitoring project using data from 2015-2021. The end goal is to re-produce a non-metric multidimensional scaling (MDS) plot similar to the one in Tronstad et al. 2020. To re-create that plot, the first step is to calculate **Average density across replicates/fractions for each taxon and year** for each site. 

Currently, data is in two different formats: 

  a. 2015-2018 - "cleaned" format has columns: stream, name, type, site, year, date, area, fraction (large or small), Sampler, NoSurber, Rep (1, 2, or 3), Taxa, Biomass, Abundance, and Density. 
  
  b. 2019-2021 - "raw" data has columns: park, sampler, stream, date, rep (1, 2, or 3), fraction (large or small), Taxa, L1:L20 (# of L columns varies), MeanLength(mm), IndBiomass(mg_ind), Subsample, Abundance, Density, Biomass(mg/m2), stage, and Notes. (some years also have "W1...W*n*" columns) 

A few additional notes: 
  - Both Upper and Lower sites exist for 2015 - this script ONLY uses data from the Upper sites. 
  - Adult taxa (noted in the "stage" column) will be removed before calculating densities. 

**In both cases, cleaning steps will be to: **

1. Read in raw data files
2. Remove Adults (stage == "adult")
3. Simplify data structure by selecting necessary columns for calculating density per site per year (site, year, taxon, and density)
4. Calculate density per site per year
5. Combine all density calculations into a "master" dataframe for N-MDS plotting and additional analyses. 

## Data Cleaning

**NOTE** - This script will only run if ALL input files have columns "Stream", "Year", "Taxa", "Abundance", "Density", and "Stage" (at a minimum - other columns don't need to be the same). If one of these columns is missing, add a blank column with the appropriate name to the .csv file in Excel. For The 2019-2021 files, I manually added a "Year" column with the corresponding year to each file in Excel. If one of these columns has a different name (e.g. Density(ind/m2) instead of Density), rename the column in the .csv file BEFORE running the script. 

### 1. Read in, simplify, and combine data:

First, make a list of all file names: 

```{r}
invert_files <- list.files("invert_data/raw_data/csv", full.names = T)
```

Initiate empty list for data import: 

```{r}
invert_list <- list()
```

Read in and clean data files as outlined above using a for loop: NOTE - not going to calculate mean density/total abundance yet b/c of inconsistent stream names between different years. 

```{r}
for(i in 1:length(invert_files)){
  invert_list[[i]]<-read.csv(invert_files[[i]])%>% #store first .csv in file name list as first data frame in invert_list
   filter(!(Stage == "adult"| Stage == "Adult"))%>% #1. Remove any observations where "Stage" = adult OR Adult
    select(Stream, Year, Taxa, Density, Abundance) #2. Select desired columns: stream, year, taxa, and density
}

```

Combine all density calculations into a "master" dataframe for N-MDS plotting + additional analysis: 

```{r}
invert_rbind <- invert_list %>%
  bind_rows()%>%
  arrange(Stream, Year)
```

### 2. Deal with inconsistencies in Site & Taxa naming

Checking for inconsistent site names: 

```{r}
unique(invert_rbind$Stream)
```

Lots of inconsistency in site naming, plus some rows with no site name. Next steps: delete rows with no site name; standardize other names

Remove rows w/out stream name:

```{r}
invert_rbind <- invert_rbind%>%
  filter(!Stream == "")
```

Standardize stream names: 

```{r}
invert_rename <- invert_rbind %>%
  mutate(Stream = case_when( # Using case_when + str_detect (stringr package) to rename all cells that contain a given text string to the specified new value - a little clunky, but effective. 
    str_detect(Stream, "Delta") ~ "delta", 
    str_detect(Stream, "Cloudveil") ~ "cloudveil", 
    str_detect(Stream, "Basin South")|str_detect(Stream, "Icy Seep")|str_detect(Stream, "Basin RG") ~ "s_ak_basin", 
    str_detect(Stream, "Basin North")~ "n_ak_basin", 
    str_detect(Stream, "Grizzly")~ "grizzly", 
    str_detect(Stream, "Mica") ~ "mica", 
    str_detect(Stream, "North Fork Teton")|str_detect(Stream, "NF Teton")~"n_teton", 
    str_detect(Stream, "Paintbrush")~"paintbrush", 
    str_detect(Stream, "Quad")~"quad_cr", 
    str_detect(Stream, "Silver") ~"silver_run", 
    str_detect(Stream, "Cascade")~"s_cascade", 
    str_detect(Stream, "South Fork Teton")|str_detect(Stream, "SF Teton")~"s_teton", 
    str_detect(Stream, "Froze")~"froze_to_death", 
    str_detect(Stream, "Middle")~"mid_teton", 
    str_detect(Stream, "Skillet")~"skillet", 
    str_detect(Stream, "Gusher")~"gusher", 
    str_detect(Stream, "Beartooth")~"beartooth_cr", 
    str_detect(Stream, "Death Rock")~"death_canyon", 
    str_detect(Stream, "Petersen")~"petersen", 
    str_detect(Stream, "Wind")~"windcave" 
  ))
```

Check the output: 

```{r}
unique(invert_rename$Stream)
```


Also need to check for different spellings/etc of Taxa names: 

```{r}
invert_rename1 <- invert_rename %>%
  mutate(taxa_lwr = tolower(Taxa))%>% #make all lowercase first to get rid of some duplicates w/ different cases
  mutate(taxa_lwr = str_replace(taxa_lwr, "pupae", ""))%>% #remove "pupae" label from all names
  mutate(taxa_lwr = str_replace(taxa_lwr, "pupa", ""))%>% #remove "pupa" label from all names
  filter(!str_detect(taxa_lwr, "adult"))%>% #removing any rows with "adult" in any part of the taxa name
  arrange(taxa_lwr)

unique(invert_rename1$taxa_lwr) #check unique values
```

Fixing repeats/spelling errors: 

```{r}
invert_rename2 <- invert_rename1%>% 
  mutate(taxa_lwr = ifelse(str_detect(taxa_lwr, "megarcys"), "megarcys", taxa_lwr))%>% 
  mutate(taxa_lwr = str_replace(taxa_lwr, "chrionomidae", "chironomidae"))%>%
  mutate(taxa_lwr = str_replace(taxa_lwr, "venma", "vemna"))%>% 
  mutate(taxa_lwr = str_replace(taxa_lwr, "brannea", "brunnea"))%>%
  mutate(taxa_lwr = str_replace(taxa_lwr, "homp", "homop"))%>%
  mutate(taxa_lwr = ifelse(taxa_lwr == "non-tany", "non-tanypodinae", taxa_lwr))%>%
  mutate(taxa_lwr = str_replace(taxa_lwr, "prosimuliium", "prosimulium"))%>%
  mutate(taxa_lwr = str_replace(taxa_lwr, "coloradenis", "coloradensis"))%>%
  mutate(taxa_lwr = str_replace(taxa_lwr, "group", ""))%>% #remove "group" from all names
  mutate(taxa_lwr = str_replace(taxa_lwr, "sub", "subgroup"))%>% #add "group" back into "subgroup" names
  mutate(taxa_lwr = str_trim(taxa_lwr, side = "both")) #remove white space from before and after all names

invert_rename2$taxa_lwr[2587] <- "rhyacophila brunnea/vemna" #manually over-writing one cell that wasn't correcting using fxns above for some reasons


unique(invert_rename2$taxa_lwr) #checking resulting unique values
```


---
---

### 3. Calculate average density & total abundance for each taxa/site/yr


Now, calculate average density and total abundance for each taxa for each year in each site; add source info: 

```{r}
invert_avgs <- invert_rename2 %>%
  group_by(Stream, Year, taxa_lwr) %>% # group by taxa w/in year w/in stream
  summarise(density_xbar = mean(Density), #calculate mean density for each taxa/year/site
            abundance_total = sum(Abundance))#calculate total abundance for each taxa/yr/site

source <- read.csv("source_info.csv")%>% #read in source data
  rename(Stream = stream) #rename for merge

invert_avgs <- merge(invert_avgs, source)%>%
    filter(!density_xbar == 0)%>% #remove extra taxa names that have no observations
    arrange(Stream, Year) #sort by stream & year

```

Save this file for future analysis: 

```{r}
write.csv(invert_avgs, "invert_data/cleaned_csv/full_invert_densities.csv")

```


## Plotting & Analysis

### 1. Making a non-metric MDS site for the long-term sites

#### Data Subsetting

**Updates 4/27: Use all sites w/ 2+yrs of data; use log transform of density measurements; remove taxa that only occur at one site; remove taxa that represent <1% of total abundance** 

*Remove sites with only one year of data*

First, ID which sites have 2+ yrs of data: 

```{r}
site_lengths <- invert_avgs %>%
  group_by(Stream)%>%
  summarise(first = min(Year), 
            last = max(Year))%>%
  mutate(monitoring_yrs = (last-first)+1)%>%
  arrange(desc(monitoring_yrs))
site_lengths
```

Make a list of site names w/ only one year of data:

```{r}
one.yr <- site_lengths %>%
  filter(monitoring_yrs < 2)%>% #select sites w/ <2yrs data
  select(Stream) #remove extra cols
```

Remove all observations from streams with one year of data:

```{r}
two_plus <- invert_avgs %>%
  filter(!Stream%in%one.yr$Stream) #remove all rows with a value of "Stream" that occurs "in" the one.yr$stream vector created above. 
```

*Remove taxa that only occur at one site*

Calculate # of different sites @ which each taxa occurs; make a list of all taxa occurring at only one site:

```{r}
one.site <- two_plus %>%
  group_by(taxa_lwr)%>% #group by taxa
  summarise(no_sites = length(unique(Stream)))%>% #count # of unique site names w/in each taxa group
  arrange(no_sites)%>% #sort by site count
  filter(no_sites == 1) #extract all taxa occuring at only one site
```

Remove these taxa from the main dataframe:

```{r}
no_single <- two_plus %>%
  filter(!taxa_lwr%in%one.site$taxa_lwr)
```

*Remove taxa that account for <1% of total abundance*

NOTE - using a 1% threshold for each site/year (ie removing any species that makes up <1% of the total abundance for a given site in a given year). 

Calculate total abundance per site per year:

```{r}
overall.abundance <- no_single %>%
  group_by(Stream, Year)%>% #group by stream and year
  summarise(tot_abund = sum(abundance_total, na.rm = T)) #calculate total abundance w/in each site + year combo
```

Calculate % of total abundance for each taxa for each year; remove any taxa w/ <1% of total abundance:

```{r}
no_rare <- merge(no_single, overall.abundance)%>% #add total abundance for each site + year to main dataset
  mutate(ab_perc = (abundance_total/tot_abund)*100)%>% #calculate abundance percent
  filter(!ab_perc < 1) #remove all taxa with abundance percent <1
```

*Calculate log transform of remaining density data*: 

```{r}
nmds_data <- no_rare %>%
  mutate(log10_density = log10(density_xbar))%>%
  select(Stream, Year, taxa_lwr, log10_density)
```

#### Data re-organization

Goal is to run an NMDS treating each stream+year combo as a unique "site" - will need: 
  - Columns with stream name and year (for plotting later)
  - ID column with stream name + year (to use as the "site" identifier in the NMDS)
  - Columns for each taxa, rows populated with density for that combo of site/year and taxa

Create site + year index column; pivot wider to get columns for each taxa:

```{r}
nmds_wide <- nmds_data %>%
  pivot_wider(id_cols = c(Stream, Year), values_from = log10_density, names_from = taxa_lwr)%>%
  mutate_if(is.numeric, ~replace_na(.,0))
```

**Note - still have some species that only occur @ 1 site in this data after removing taxa that account for <1% of total abundance at each site/yr**

#### Run NMDS:

Run the NMDS using the metaMDS fuction (vegan pkg):

```{r}
set.seed(1) #for reproducability
full.mds <- metaMDS(comm = nmds_wide[,3:18], #specify community as columns 4-18
                    distance = "bray") #use bray-curtis distance calc
full.mds
```

#### NMDS Plotting:

Data set-up: extract point locations for plot creation:

```{r}
mds_scores <- as.data.frame(scores(full.mds)$site)%>% #extract point locations for each site (stream*year combo)
  mutate(stream = nmds_wide$Stream,  
         year = nmds_wide$Year)#%>%#add columns for stream, and year
  #mutate(stream_code = case_when(stream == "mid_teton"~"MT", stream == "n_teton" ~"NT", stream == "s_ak_basin"~"AK", stream == "s_cascade"~"SC", stream == "s_teton" ~ "ST", stream == "windcave" ~ "WC")) #Add "stream_code" column for point labeling

mds_species <- as.data.frame(scores(full.mds)$species)%>% #Extract point locations for each species
  rownames_to_column(var = "species") #convert rownames to a column w/species names
```

Create plots:

*first pass: putting everything on one plot:*




Add source info: 

```{r}
source <- read.csv("source_info.csv") #read in sources

mds_scores <- merge(mds_scores, source) #merge source and stream code info with scores dataframe

#new dataframe for adding site labels (1 per site):
site_labels <- mds_scores %>% 
  group_by(stream, stream_code, source) %>% # group by stream
  summarise(NMDS1 = mean(NMDS1), 
            NMDS2 = mean(NMDS2)) %>% #extract NMDS coordinates for first observation for each stream
  ungroup() #ungroup
```


Calculating convex hulls for each group:

```{r}
# Find the convex hull of the points being plotted
hull <- mds_scores %>% 
  group_by(stream) %>%
  slice(chull(NMDS1, NMDS2))
```

Plotting:

*Color by site; diff shapes = diff years*

```{r}
nmds.site <- ggplot(mds_scores)+
  geom_point(data = mds_species, aes(x = NMDS1, y = NMDS2), alpha = 0.5, size = 1)+ #add points for each species, adjust opacity & size
  geom_text(data = mds_species, aes(x = NMDS1, y = NMDS2, label = species), #add labels to each taxa point
            size = 3, color = "Grey", hjust = 0.5, vjust = -0.5, fontface = "italic")+ #adjusting size, color, position, and face of taxa labels
  geom_point(data = mds_scores, aes(x = NMDS1, y = NMDS2, color = stream, shape = as.factor(year)), size = 3)+ #add points for each site (stream+year combo); color code by stream, different shapes for different years. 
  #geom_text(data = mds_scores, aes(x = NMDS1, y = NMDS2, label = stream_code), #add stream code labels to each site point
    # hjust = 0, vjust = -1, fontface = "bold")+ #adjusting position and face of stream code labels
  geom_polygon(data = hull, alpha = 0.2, aes(x = NMDS1, y = NMDS2, fill = stream, color = stream))+ #add hulls for each group
  annotate(geom = "text", x = -0.6, y = 1.2, size = 4, fontface = "italic", label = paste("Stress: ", round(full.mds$stress, digits = 3)))+ #adding label to plot with stress score from model
  theme_classic()+ 
  theme(legend.position = "right")+
  labs(color = "Stream", shape = "Year")+
  scale_color_manual(values = c(brewer.pal(12, "Set3"), "#000000"), name = "Stream"
                     #, labels = c("Middle Teton", "North Teton","AK Basin S", "South Cascade", "South Teton", "Wind Cave")
                     )+ #adjusting color palatte and labels
  scale_shape_manual(values = c(15, 16, 17, 3, 4, 18, 6, 7))+ #setting shape palatte
  scale_fill_manual(values = c(brewer.pal(12, "Set3"), "#000000"), name = "Stream")+ #setting fill pallate
  labs(fill = "Stream", color = "Stream", shape = "Year")
nmds.site
```

```{r}
ggsave("invert_data/plots/nmds_site.pdf", nmds.site, device = "pdf", width = 6.5, height = 5, units = "in", dpi = "retina")
```

*Color by source; shape = year; label with stream codes*

```{r}
source.pal <- c("#C6DBEF" , "#4292C6" , "#08306B", "#000000")

nmds.source <- ggplot(mds_scores)+
  geom_point(data = mds_species, aes(x = NMDS1, y = NMDS2), alpha = 0.5, size = 1)+ #add points for each species, adjust opacity & size
  geom_text(data = mds_species, aes(x = NMDS1, y = NMDS2, label = species), #add labels to each taxa point
            size = 3, color = "Grey", hjust = 0.5, vjust = -0.5, fontface = "italic")+ #adjusting size, color, position, and face of taxa labels
  geom_point(data = mds_scores, aes(x = NMDS1, y = NMDS2, color = source, shape = as.factor(year)), size = 3)+ #add points for each site; color code by source, different shapes for different years. 
  geom_text(data = site_labels, aes(x = NMDS1, y = NMDS2, label = stream_code, color = source), #add stream code labels to each site point
     hjust = 0, vjust = 0, fontface = "bold")+ #adjusting position and face of stream code labels
  geom_polygon(data = hull, alpha = 0.2, aes(x = NMDS1, y = NMDS2, fill = source, color = source))+ #add hulls for each stream, color coded by source
  annotate(geom = "text", x = -0.6, y = 1.2, size = 4, fontface = "italic", label = paste("Stress: ", round(full.mds$stress, digits = 3)))+ #adding label to plot with stress score from model
  theme_classic()+ 
  theme(legend.position = "right")+
  labs(fill = "Source", color = "Source", shape = "Year")+
  scale_color_manual(values = source.pal, name = "Source"
                     , labels = c("Glacier", "Snowmelt", "Subterranean Ice", "Unknown")
                     )+ #adjusting color palatte and labels
  scale_shape_manual(values = c(15, 16, 17, 3, 4, 18, 6, 7))+ #setting shape palatte
  scale_fill_manual(values = source.pal, name = "Source", labels = c("Glacier", "Snowmelt", "Subterranean Ice", "Unknown")) #setting fill pallate
nmds.source
```

```{r}
ggsave("invert_data/plots/nmds_source.pdf", nmds.source, device = "pdf", width = 9.5, height = 6.5, units = "in", dpi = "retina")
```



*Facet by source*:

```{r}
source.facet <- ggplot(mds_scores)+
  geom_point(data = mds_species, aes(x = NMDS1, y = NMDS2), alpha = 0.5, size = 1)+ #add points for each species, adjust opacity & size
  geom_text(data = mds_species, aes(x = NMDS1, y = NMDS2, label = species), #add labels to each taxa point
            size = 3, color = "Grey", hjust = 0.5, vjust = -0.5, fontface = "italic")+ #adjusting size, color, position, and face of taxa labels
  geom_point(data = mds_scores, aes(x = NMDS1, y = NMDS2, color = source, shape = as.factor(year)), size = 3)+ #add points for each site; color code by source, different shapes for different years. 
  geom_text(data = site_labels, aes(x = NMDS1, y = NMDS2, label = stream_code), #add stream code labels to each site point
     hjust = 0, vjust =0, fontface = "bold")+ #adjusting position and face of stream code labels
  geom_polygon(data = hull, alpha = 0.2, aes(x = NMDS1, y = NMDS2, fill = source, color = source))+ #add hulls for each stream, color coded by source
  theme_classic()+ 
  theme(legend.position = "right", 
        plot.tag.position = c(0.87, 0.1), 
        plot.tag = element_text(size = 10, face = "italic"))+
  labs(fill = "Source", color = "Source", shape = "Year", tag = paste("Stress: ", round(full.mds$stress, digits = 3)))+
  scale_color_manual(values = source.pal, name = "Source",labels = c("Glacier", "Snowmelt", "Subterranian Ice", "Unknown"))+ #adjusting color palatte and labels
  scale_shape_manual(values = c(15, 16, 17, 3, 4, 18, 6, 7))+ #setting shape palatte
  scale_fill_manual(values = source.pal, labels = c("Glacier", "Snowmelt", "Subterranian Ice", "Unknown"),name = "Source")+ #setting fill pallate
  facet_wrap(~source)
source.facet
```

```{r}
ggsave("invert_data/plots/nmds_source_facet.pdf", source.facet, device = "pdf", units = "in", height = 5, width = 6.5, dpi = "retina")
```

**Same as above, but only TASR Sites**

Data Prep:

```{r}
tasr.sites <- c("cloudveil", "delta", "grizzly", "gusher", "mid_teton", "n_teton", "paintbrush", "s_ak_basin", "s_cascade", "s_teton", "skillet", "windcave") #make list of TASR sites

tasr_nmds <- mds_scores %>%
  filter(stream%in%tasr.sites) #extract data for TASR sites from mds_scores data

tasr_labels <- site_labels%>%
  filter(stream%in%tasr.sites) #extract TASR site labels for plotting

pres.pal <- c("#C26ED6", "#F89225", "#76D96F") #matching color pallate to site map

```

Plotting:

```{r}
tasr.facet <- ggplot(tasr_nmds)+
  geom_point(data = mds_species, aes(x = NMDS1, y = NMDS2), alpha = 0.5, size = 1)+ #add points for each species, adjust opacity & size
  geom_text(data = mds_species, aes(x = NMDS1, y = NMDS2, label = species), #add labels to each taxa point
            size = 3, color = "Grey", hjust = 0.5, vjust = -0.5, fontface = "italic")+ #adjusting size, color, position, and face of taxa labels
  geom_point(data = tasr_nmds, aes(x = NMDS1, y = NMDS2, color = source, shape = as.factor(year)), size = 3)+ #add points for each site; color code by source, different shapes for different years. 
  geom_text(data = tasr_labels, aes(x = NMDS1, y = NMDS2, label = stream_code), #add stream code labels to each site point
     hjust = 0, vjust =0, fontface = "bold")+ #adjusting position and face of stream code labels
  geom_polygon(data = hull, alpha = 0.2, aes(x = NMDS1, y = NMDS2, fill = source, color = source))+ #add hulls for each stream, color coded by source
  theme_classic()+ 
  theme(legend.position = "right", 
        plot.tag.position = c(0.87, 0.1), 
        plot.tag = element_text(size = 10, face = "italic"), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 10), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))+
  labs(fill = "Source", color = "Source", shape = "Year", tag = paste("Stress: ", round(full.mds$stress, digits = 3)))+
  scale_color_manual(values = pres.pal, name = "Source",labels = c("Glacier", "Snowmelt", "Subterranian Ice", "Unknown"))+ #adjusting color palatte and labels
  scale_shape_manual(values = c(15, 16, 17, 3, 4, 18, 6, 7))+ #setting shape palatte
  scale_fill_manual(values = pres.pal, labels = c("Glacier", "Snowmelt", "Subterranian Ice", "Unknown"),name = "Source")+ #setting fill pallate
  facet_wrap(~source)
tasr.facet
```

Save:

```{r}
ggsave("pres_figures/tasr_nmds.pdf", tasr.facet, width = 8.5, height = 6.5, units = "in", device = "pdf", dpi = "retina")
```

*Seperating into facets for each site*

```{r}
nmds.facet <- ggplot(mds_scores)+
  #geom_point(data = mds_species, aes(x = NMDS1, y = NMDS2), alpha = 0.5, size = 1)+
  #geom_text(data = mds_species, aes(x = NMDS1, y = NMDS2, label = species), size = 3, color = "Grey", hjust = 0.5, vjust = -0.5, fontface = "italic")+
  geom_point(aes(x = NMDS1, y = NMDS2, color = as.numeric(year)), size = 2)+
  geom_path(mapping = aes(x = NMDS1, y = NMDS2, color = as.numeric(mds_scores$year)), arrow = arrow(type = "closed", ends = "last", length = unit(0.2, "cm")))+
  theme_classic()+
  facet_wrap(~stream)+
  theme(legend.direction = "horizontal", 
        legend.position = c(0.75, 0.05), 
        plot.tag.position = c(0.5, 0.1), 
        plot.tag = element_text(size = 10, face = "italic"), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 10), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))+
  labs(color = "Year", tag = paste("Stress: ", round(full.mds$stress, digits = 3)))+
  scale_color_gradient(low = "#C6DBEF", high = "#084594", labels = c(2015, 2018, 2021), breaks = c(2015, 2018, 2021))
nmds.facet
```

```{r}
ggsave("invert_data/plots/nmds_facet.pdf", nmds.facet, device = "pdf", width = 6.5, height = 6.5, units = "in", dpi = "retina")
```

**Same as above, but just for TASR sites:***

```{r}
tasr.nmds.line <- ggplot(tasr_nmds)+
  #geom_point(data = mds_species, aes(x = NMDS1, y = NMDS2), alpha = 0.5, size = 1)+
  #geom_text(data = mds_species, aes(x = NMDS1, y = NMDS2, label = species), size = 3, color = "Grey", hjust = 0.5, vjust = -0.5, fontface = "italic")+
  geom_point(aes(x = NMDS1, y = NMDS2, color = as.numeric(year)), size = 2)+
  geom_path(mapping = aes(x = NMDS1, y = NMDS2, color = as.numeric(tasr_nmds$year)), arrow = arrow(type = "closed", ends = "last", length = unit(0.2, "cm")))+
  theme_classic()+
  facet_wrap(~full_name, nrow = 2, ncol = 6)+
  theme(legend.direction = "horizontal", 
        legend.position = "bottom", 
        plot.tag.position = c(0.3, 0.1), 
        plot.tag = element_text(size = 10, face = "italic"), 
        axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 10), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 10, face = "bold"))+
  labs(color = "Year", tag = paste("Stress: ", round(full.mds$stress, digits = 3)))+
  scale_color_gradient(low = "#C6DBEF", high = "#084594", labels = c(2015, 2018, 2021), breaks = c(2015, 2018, 2021))
tasr.nmds.line
```

```{r}
ggsave("pres_figures/tasr_nmds_line.pdf", tasr.nmds.line, width = 12.5, height = 5, units = "in", device = "pdf", dpi = "retina")
```


*Just plotting first and last year for each site*

```{r}
nmds.simple <- ggplot(filter(mds_scores, year == 2016|year == 2021))+ #filtering data to only include 2016 & 2021
  geom_point(data = mds_species, aes(x = NMDS1, y = NMDS2), alpha = 0.5, size = 1)+
  geom_text(data = mds_species, aes(x = NMDS1, y = NMDS2, label = species), size = 3, color = "Grey", hjust = 0.5, vjust = -0.5, fontface = "italic")+
  geom_point(data = filter(mds_scores, year == 2016|year == 2021), aes(x = NMDS1, y = NMDS2, color = stream, shape = as.factor(year)), size = 3)+
  geom_text(data = filter(mds_scores, year == 2016|year == 2021), aes(x = NMDS1, y = NMDS2, label = stream_code), hjust = -0.3, vjust = 0.1, fontface = "bold")+
  annotate(geom = "text", x = -0.7, y = 0.9, size = 4, fontface = "italic", label = paste("Stress: ", round(full.mds$stress, digits = 3)))+
  theme_classic()+
  theme(legend.position = "right")+
  labs(color = "Stream", shape = "Year")+
  scale_color_manual(values = c(brewer.pal(12, "Set3"), "#000000")
                    # , labels = c("Middle Teton", "North Teton","AK Basin S", "South Cascade", "South Teton", "Wind Cave")
                     )+
  scale_shape_manual(values = c(15, 16))
nmds.simple
```

Save:

```{r}
ggsave("invert_data/plots/nmds_simple.jpg", nmds.simple, device = "jpeg", width = 6.5, height = 5, units = "in", dpi = "retina") #Save plot
```

#### Statistics - how do convex hull areas compare amongst sources? 

First, need to calculate area of convex hulls, which will require converting them to polygons. Formatting-wise, this means we'll need to repeat the first row for each site at the end of that site to "close" the polygon:

Split data by site:

```{r}
hull_split <- split(hull, hull$stream)
```

Write a function to paste first row at end of dataframe and extract the hull coordinates as a matrix; apply to the split list: 

```{r}
paste.row <- function(df){
  df<-rbind(df, df[1,]) #rowbind first row to bottom of dataframe
  df<-df %>%
    select(2:3)
}

hull_split_closed <- lapply(hull_split, paste.row) #apply to hull_split list
```

Next, calculate area of each site's polygon using a for loop:

```{r}
hull_areas<-c() #initialize empty vector to recieve outputs

for(i in 1:length(hull_split_closed)){ #for each object in the hull_split_closed list:
  pg <- Polygon(hull_split_closed[[i]][,2:3], hole = F) #use columns 2 and 3 (x and y coords) to create a polygon
  hull_areas[i] <- pg@area #calculate area of that polygon and store in the hull_areas vector
}
```

Add site info back in: 

```{r}
site_areas <- hull %>%
  select(stream, source, stream_code)%>% #select desired cols
  distinct(stream, source, stream_code) #remove duplicate rows
site_areas$area <- hull_areas #add areas

site_areas <- site_areas %>%
  filter(!area == 0) #remove sites with area = 0
```

Plotting - how do areas compare between sources?

```{r}
source.areas <- ggplot(site_areas, aes(x = source, y = area, fill = source))+
  geom_boxplot()+
  theme_classic()+
  theme(legend.position = "none", 
        axis.text = element_text(size = 11), 
        axis.title= element_text(size = 12, face = "bold"))+
  scale_fill_manual(values = source.pal, labels = c("Glacier", "Snowmelt", "Subterranean Ice"))+
  labs(y = "Convex Hull Area", x = "Stream Source")
source.areas
```

Snowmelt appears to have larger area than glacier or subterranean ice - are these differences significant? 

Save: 

```{r}
ggsave("invert_data/plots/source_areas.pdf", source.areas, width = 6.5, height = 5, units = "in", device = "pdf", dpi = "retina")
```

Basic ANOVA:

```{r}
source.aov <- aov(area~source, data = site_areas)
summary(source.aov)
```

No effect of source 

```{r}
TukeyHSD(source.aov)
```

No significant differences after adding 2022 data


### 2. How is Taxonomic Richness changing over time?

First, need to calculate richness (#species present) for each site - **NOTE:** using ALL taxa from sites with >1yr data here, NOT the subset of taxa used for NMDS.

```{r}
richness <- invert_avgs %>% 
  filter(!Stream%in%one.yr$Stream)%>%
  group_by(Stream, Year, source, full_name)%>% #group by stream/year
  summarise(richness = length(unique(taxa_lwr))) #calculate # of unique values of taxa_lwr for each stream + year combo

head(richness
     )
```

Save file for future analysis:

```{r}
write.csv(richness, "invert_data/cleaned_csv/invert_richness.csv")
```

Plotting - how has richness changed over time at all of these sites? 

```{r}
richness.line <- ggplot(richness, aes(x = Year, y = richness, color = Stream))+
  geom_point()+
  geom_line()+
  geom_smooth(se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  labs(x = "Year", y = "Species Richness", color = "Stream")+
  scale_color_manual(values = c(brewer.pal(12, "Set3"), "#000000")
                     #, labels = c("Middle Teton", "North Teton", "AK Basin S", "S Cascade", "S Teton", "Wind Cave")
                     )
richness.line
```

Appears to be a decreasing trend in richness across most sites - are any of these trends significant?

(save this plot)

```{r}
ggsave("invert_data/plots/richness_line.pdf", richness.line, device = "pdf", height = 4, width = 6.5, units = "in", dpi = "retina")
```


#### LM for richness ~ year: 

First, nest data based on site: 

```{r}
richness_nested <- richness %>%
  nest(data = -Stream) #create new nested dataframe with one column for Stream, one column for data - data entries for each site include year and richness. 
```

Next, run a model for each site separately and return a summary table with the results for each site:

```{r}
richness_models <- richness_nested %>%
  mutate(model = map(data, ~lm(richness~Year, data = .)%>% #run a model of richness~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "Year")  #remove intercept term to just get info on year for each site
richness_models
```

Significant declines (p<0.05) in richness at s cascade, weakly significant (p<0.1) decreases at Cloudveil. 

#### Presentation Richness plot: 

**Richness at 12 TASR sties, add trendline for overall average**

Data prep:

```{r}
tasr.sites <- c("cloudveil", "delta", "grizzly", "gusher", "mid_teton", "n_teton", "paintbrush", "s_ak_basin", "s_cascade", "s_teton", "skillet", "windcave") #make list of TASR sites

tasr_richness <- richness %>%
  filter(Stream%in%tasr.sites) #remove non-TASR sites
```

Plotting: 

```{r}
tasr.richness <- ggplot(tasr_richness, aes(x = Year, y = richness, color = full_name))+
  geom_point(alpha = 0.5)+
  geom_line(alpha = 0.5)+
  geom_line(stat = "smooth", method = "lm", formula = y~x, linetype = "dashed", size = 0.5, alpha = 0.5)+
  geom_smooth(aes(x = Year, y = richness), se = F, method = "lm", linetype = "dashed", size = 1, color = "Black")+
  theme_classic()+
  labs(x = "Year", y = "Species Richness", color = "Stream")+
  scale_color_manual(values = c(brewer.pal(8, "Dark2"), brewer.pal(4, "Set1")))+
  theme(axis.title = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 10), 
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 11, face = "bold"))+
  ylim(0, 32)
tasr.richness
```

Save: 

```{r}
ggsave("pres_figures/tasr_richness.pdf", tasr.richness, width = 12, height = 5, units = "in", device = "pdf", dpi = "retina")
```

#### Richness across all sites: 

Calculate total richness (no taxa) observed across all sites for each year **NOTE**: using ALL taxa from sites with >1yr data here, NOT the subset of taxa used for NMDS.

```{r}
yearly_richness <- invert_avgs %>%
  filter(!Stream%in%one.yr$Stream)%>%
  group_by(Year)%>%
  summarise(total_richness = length(unique(taxa_lwr)))
```

Plotting: 

```{r}
yearly.richness <- ggplot(yearly_richness, aes(x = Year, y = total_richness, color = as.numeric(Year)))+
  geom_point()+
  geom_line()+
  geom_smooth(aes(x = Year, y= total_richness, color = as.numeric(Year)), se = F, method = "lm", linetype = "dashed", size = 0.5)+
  theme_classic()+
  labs(x = "Year", y = "Species Richness", color = "Year")+
  scale_color_gradient(low = "#C6DBEF", high = "#084594", labels = c(2015, 2018, 2021), breaks = c(2015, 2018, 2021))+
  theme(legend.position = "none")
  
yearly.richness
```

Save: 

```{r}
ggsave("invert_data/plots/yearly_richness.pdf", yearly.richness, width = 6.5, height = 4, units = "in", dpi = "retina")
```

Basic LM:

```{r}
yr.rich <- lm(total_richness~Year, data = yearly_richness)
summary(yr.rich)
```

No significant trend. 


### 3. How does intermittency affect richness at Paintbrush?

First, extract paintbrush data:

```{r}
pb_inverts <- richness %>%
  filter(Stream == "paintbrush")
```

Read in paintbrush exposure dates (saved from teton_data_cleaning script); calculate no days exposed per year:

```{r}
pb_exposure <- read.csv("Temperature/pb_exposure.csv")%>%
  group_by(yr)%>%
  summarise(no_days = length(exposed_dates))%>%
  rename(Year = yr)
```

Merge with invert data: 

```{r}
pb_full <- merge(pb_inverts, pb_exposure, all = T)%>%
 # mutate(no_days = ifelse(Year == 2017, 0, no_days))%>% #replacing 2017 "NA" with 0 dry days
  filter(!is.na(richness), !is.na(no_days))
```

Visual check for trends:

```{r}
pb.richness <- ggplot(pb_full, aes(x = no_days, y = richness))+
  geom_point()+
  geom_line()+
  geom_smooth(method = "lm", se = F, linetype = "dashed")+
  theme_classic()+
  labs(x = "Number dry days", y = "Taxonomic Richness")
pb.richness 
```

Fairly strong negative trend, but very little data - so hard to tell if that's a "real" trend. 

```{r}
ggsave("invert_data/plots/pb_richness.pdf", pb.richness, device = "pdf", width = 6.5, height = 4, units = "in", dpi = "retina")
```

Basic LM: 

```{r}
pb.mod <- lm(richness~no_days, data = pb_full)
summary(pb.mod)
```

No significant trends, which is unsurprising bc of the very limited data - trend may emerge with longer term dataset. R2 is pretty high. 


### 4. Cumulative taxa thru time? Any new taxa showing up that weren't there previously? 

First, re-arrange data to get list of all unique taxa for each year: 

```{r}
yr_taxa <- invert_avgs %>%
  select(Year, taxa_lwr)%>% #select year and taxa columns
  group_by(Year)%>% #group by year
  summarise(taxa = unique(taxa_lwr))%>% #extract all unique values of taxa for each year
  mutate(taxa_yr = paste(Year, taxa, sep = "_"))%>% #add new col with taxa and year
  pivot_wider(names_from = Year, values_from = taxa_yr)%>% #pivot wider to get columns for each year, rows for each taxa - yearly columns will have NA's when a taxa isn't present. 
  arrange(taxa)
```

Next, convert to binary "1" for present, "0" for absent:

```{r}
to.binary <- function(col){
  col = ifelse(is.na(col), 0, 1) #write function to convert replace all NA's with 0; all other values with 1
}

yr_binary <- yr_taxa %>%
  mutate(across(.cols = c(2:9), to.binary)) #apply this function across all year columns in yr_taxa 
```

Check the resulting output: 

```{r}
head(yr_binary)
```

Want to calculate the *cumulative* richness over time - i.e. only count taxa that haven't been seen in previous years. Based on the above format, need to keep ONLY the first observation of each taxa, remove all others. 

First, re-format data to get rows for each year, columns for each taxa, fill rows with binary presence/absence data:
  
```{r}
binary_wide <- yr_binary%>%
  pivot_longer(!taxa, values_to = "presence", names_to = "yr")%>% #first pivot longer to get taxa, presence, and year columns
  pivot_wider(id_cols = yr, names_from = taxa, values_from = presence) #then pivot wider using year as ID col instead of taxa to get cols for each taxa, fill in with presence/absence data
```

Next, need to replace all subsequent observations with a 0 to get a dataframe that has a 1 for a given taxa in the year that that taxa first ocurred, 0 in all other rows for that taxa. 

```{r}
apperance.calc <- function(x){ #write a function to:
  x = cumsum(x) #a. calculate the cumulative sum of each column
  x = ifelse(x == 1 &lag(x) == 0, 1, 0)  #b. replace all cells that are not = 1 and don't have 0 in the previous cell with 0's. 
}

binary_lag <- binary_wide %>%
  mutate(across(c(2:ncol(binary_wide)), apperance.calc))#apply to all taxa cols

binary_lag[1,]<-binary_wide[1,] #replace first row (will be all NAs) with first row from original wide dataframe
```


Now, calculate new taxa observed in each year by calculating row sums for all taxa columns: 

```{r}
new_taxa <- rowSums(binary_lag[,2:ncol(binary_lag)])
```

Add this to a new dataframe with year; calculate cumulative taxa observed each year: 

```{r}
cumulative_richness <- data.frame(c(2015:2022), new_taxa)%>% #bind new_taxa object with vector of years
  rename(yr = 1)%>% #rename first column "yr"
  mutate(cumulative_taxa =cumsum(new_taxa)) #calculate cumulative taxa observed for each year
```

Plot:

```{r}
cum.taxa <- ggplot(cumulative_richness, aes(x = yr, y = cumulative_taxa))+ #plot x = year, y = cumulative taxa 
  geom_point()+
  geom_line()+
  theme_classic()+
  labs(x = "Year", y = "Cumulative Taxa Observed")
cum.taxa
```

Save:

```{r}
ggsave("invert_data/plots/cumulative_taxa.pdf", cum.taxa, width = 6.5, height = 4, units = "in", device = "pdf", dpi = "retina")
```

LM:

```{r}
cum.taxa.lm <- lm(cumulative_taxa~yr, data = cumulative_richness)
summary(cum.taxa.lm)
```

Significant increase in cumulative richness over time, but that could be a side effect of having data from more sites in later years. 

### 5. Relationships between Temp/SWE/Etc and richness at a given site? 

#### A. Richness ~ mean summer (July-Aug) stream temp; mean summer max and min temp:

First, read in cleaned temperature dataset: 

```{r}
temps <- read.csv("Temperature/cleaned_full_datasets/temps_daily.csv")
head(temps)
```

Next, calculate mean summer (July-Aug) stream temperature for each year at each site: 

```{r}
summer_temps <- temps %>%
  mutate(date1 = ymd(date1), #recode date as r date obj
         mo = month(date1), #new col with month
         yr = year(date1))%>% #new col with year
  filter(mo == 6 | mo == 7 | mo ==8)%>% #extract rows with month = 6, 7, or 8
  group_by(site, yr)%>% #group by site and year
  summarise(t_xbar = mean(temp_xbar, na.rm = T), #calculate mean summer temp
            tmax_xbar = mean(temp_max, na.rm = T), #calculate avg max temp 
            tmin_xbar = mean(temp_min, na.rm = T)) %>%#calculate avg min temp
  rename(Stream = site, Year = yr) #renaming for merge

```

Next, merge with richness dataset: 

```{r}
richness_temps <- merge(summer_temps, richness)
```

Visual comparison: any visible relationships between richness, mean summer temp, mean max or mean min temp? 

**Mean summer temp**: 

```{r}
txbar.richness <- ggplot(filter(richness_temps, !Stream == "silver_run"), aes(x = t_xbar, y = richness, color = Stream))+
  geom_point()+
  geom_line()+
  theme_classic()+
  facet_wrap(~Stream, scales = "free_x")+
  theme(legend.position = "none")+
  labs(x = "Mean summer (June-Aug.) stream temperature, C", y = "Taxonomic Richness")
txbar.richness
```

**Mean summer max temp**: 

```{r}
tmax.richness <- ggplot(filter(richness_temps, !Stream == "silver_run"), aes(x = tmax_xbar, y = richness, color = Stream))+
  geom_point()+
  geom_smooth(se = F, linetype = "dashed", method = "lm")+
  theme_classic()+
  facet_wrap(~Stream, scales = "free_x")+
  theme(legend.position = "none")+
  labs(x = "Mean maximum summer (June-Aug.) stream temperature, C", y = "Taxonomic Richness")
tmax.richness
```

**Mean summer min temp**: 

```{r}
tmin.richness <- ggplot(filter(richness_temps, !Stream == "silver_run"), aes(x = tmin_xbar, y = richness, color = Stream))+
  geom_point()+
  geom_smooth(se = F, linetype = "dashed", method = "lm")+
  theme_classic()+
  facet_wrap(~Stream, scales = "free_x")+
  theme(legend.position = "none")+
  labs(x = "Mean minimum summer (June-Aug.) stream temperature, C", y = "Taxonomic Richness")
tmin.richness
```

No obvious relationships between summer temps and richness within sites - what about across sites? 

```{r}
st.richness.all <- ggplot(richness_temps, aes(x = t_xbar, y = richness))+
  geom_point()+
  geom_smooth(se = F, linetype = "dashed", method = "lm")+
  theme_classic()+
  theme(legend.position = "none")+
  labs(x = "Mean summer (June-Aug.) stream temperature, C", y = "Taxonomic Richness")
st.richness.all
```

No obvious trends there either. 

#### LM Richness ~ Summer Temps: 

First, nest data based on site: 

```{r}
rt_nested <- richness_temps %>%
  nest(data = -Stream) #create new nested dataframe with one column for Stream, one column for data - data entries for each site include year and richness. 
```

Next, run a model of richness ~ mean temp for each site separately and return a summary table with the results for each site:

```{r}
rt_models <- rt_nested %>%
  mutate(model = map(data, ~lm(richness~t_xbar, data = .)%>% #run a model of richness~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "t_xbar")  #remove intercept term to just get info on year for each site
rt_models
```

Significant (-) relationship between mean summer temp and richness at Grizzly, marginally significant (-) relationship at Paintbrush and N teton. 

#### B. SWE vs. Richness

First, read in SNOTEL data, reformat: 

```{r}
snotel <- read.csv("teton_snotel.csv")%>%
  mutate(date = mdy(date), #recode date as date format
         yr = year(date))%>% #new column with year
  select(date, yr, station_name, swe_cm, snowdepth_cm) #select desired columns
```

Next, extract maximum SWE and snow depth for each year: 

```{r}
snow_max <- snotel %>%
  group_by(station_name, yr)%>% #group by station name & year
  summarise(swe_max = max(swe_cm, na.rm = T) #calculate max SWE
           )%>% 
  rename(Year = yr)%>% #rename year col for merge
  pivot_wider(id_cols = Year, names_from = station_name, values_from = swe_max)%>% #pivot wider to get seperate cols for each station
  rename(targhee_swe = 2, phillips_swe = 3) #rename swe columns
```

Merge with richness dataset:

```{r}
richness_swe <- merge(richness, snow_max)%>%
  arrange(Stream)
```

Visual check for trends:

**Targhee**:

```{r}
targhee.richness <- ggplot(filter(richness_swe, !Stream == "silver_run"), aes(x = targhee_swe, y = richness, color = Stream))+
  geom_point()+
  geom_smooth(se = F, linetype = "dashed", method = "lm")+
  theme_classic()+
  facet_wrap(~Stream)+
  theme(legend.position = "none")+
  labs(x = "Maximum SWE, Grand Targhee SNOTEL Station", y = "Taxonomic Richness")
targhee.richness
```

#### LM Richness ~ Targhee SWE: 

First, nest data based on site: 

```{r}
rswe_nested <- richness_swe %>%
  nest(data = -Stream) #create new nested dataframe with one column for Stream, one column for data - data entries for each site include year and richness. 
```

Next, run a model of richness ~ Targhee SWE for each site separately and return a summary table with the results for each site:

```{r}
rswe_models <- rswe_nested %>%
  mutate(model = map(data, ~lm(richness~targhee_swe, data = .)%>% #run a model of richness~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "targhee_swe")  #remove intercept term to just get info on year for each site
rswe_models
```
No significant relationships between Max SWE at Targhee and richness

**Phillips**:

```{r}
phillips.richness <- ggplot(filter(richness_swe, !Stream == "silver_run"), aes(x = phillips_swe, y = richness, color = Stream))+
  geom_point()+
  geom_smooth(se = F, linetype = "dashed", method = "lm")+
  theme_classic()+
  facet_wrap(~Stream)+
  theme(legend.position = "none")+
  labs(x = "Maximum SWE, Phillips Bench SNOTEL Station", y = "Taxonomic Richness")
phillips.richness
```

#### LM Richness ~ Phillips Bench SWE

```{r}
rswe_pb<- rswe_nested %>%
  mutate(model = map(data, ~lm(richness~phillips_swe, data = .)%>% #run a model of richness~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "phillips_swe")  #remove intercept term to just get info on year for each site
rswe_pb
```

Significant (-) relationship between SWE @ Phillips bench and richness at Cloudveil; close to significant at S cascade. 

### 6. Temperature variability vs. richness? 

### 7. Ternary diagram comparing sources (Glacier, Snow, Sub Ice)






